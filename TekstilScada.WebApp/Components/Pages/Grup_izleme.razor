@page "/group"
@layout EmptyLayout
@attribute [AllowAnonymous]

@using TekstilScada.WebApp.Services
@using TekstilScada.Models
@using TekstilScada.WebApp.Components.Shared
@using TekstilScada.WebApp.Components.Layout
@using MudBlazor
@using TekstilScada.Core.Localization
@using Microsoft.Extensions.Localization
@using System.Globalization @* <-- Dil sabitleme için gerekli *@
@inject ScadaDataService ScadaService
@inject NavigationManager NavManager
@inject IStringLocalizer<SharedResource> Loc

@implements IDisposable

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<div class="dashboard-container">

    @if (_isLoading)
    {
        <div class="loading-overlay">
            <p>@Loc["VerilerYukleniyor"]</p>
        </div>
    }
    else
    {
        <div class="kpi-cards-row">
            <KpiCard Title="@Loc["ToplamMakine"]" Value="@TotalMachines.ToString()" CssClass="kpi-info" />
            <KpiCard Title="@Loc["AktifMakine"]" Value="@RunningMachines.ToString()" CssClass="kpi-success" />
            <KpiCard Title="@Loc["AlarmdakiMakine"]" Value="@AlarmMachines.ToString()" CssClass="kpi-danger" />
            <KpiCard Title="@Loc["BekleyenMakine"]" Value="@IdleMachines.ToString()" CssClass="kpi-warning" />
        </div>

        <MudPaper Elevation="3" Class="pa-4 mb-4 rounded-lg" Style="background-color: #1e1e2d; color: #f0f0f0; border: 1px solid #333;">
            <div class="d-flex align-center justify-space-between" @onclick="ToggleFilterVisibility" style="cursor: pointer;">
                <MudText Typo="Typo.h6" Color="Color.Info">
                    <MudIcon Icon="@Icons.Material.Filled.FilterList" Class="mr-2" /> @Loc["MakineFiltreleme"]
                </MudText>
                <MudIconButton Icon="@(_isFilterVisible? Icons.Material.Filled.KeyboardArrowUp : Icons.Material.Filled.KeyboardArrowDown)"
                               Color="Color.Inherit" />
            </div>

            @if (_isFilterVisible)
            {
                <MudDivider Class="my-2" Style="border-color: #444;" />
                <div class="row mt-2">
                    @if (AllMachines.Any())
                    {
                        @foreach (var machine in AllMachines)
                        {
                            <div class="col-auto mb-2">
                                <MudCheckBox T="bool"
                                             Value="@SelectedMachineIds.Contains(machine.MachineId)"
                                             ValueChanged="@((val) => ToggleMachineSelection(machine.MachineId, val))"
                                             Label="@machine.MachineName"
                                             Color="Color.Info"
                                             Dense="true"
                                             Class="filter-checkbox" />
                            </div>
                        }
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Inherit">@Loc["MakineListesiYuklenemedi"]</MudText>
                    }
                </div>
                <div class="d-flex gap-2 mt-3">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small" OnClick="ApplyFilter">@Loc["Filtrele"]</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Small" OnClick="SelectAllMachines">@Loc["TumunuSec"]</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" OnClick="ClearSelection">@Loc["SecimiTemizle"]</MudButton>
                </div>
            }
        </MudPaper>

        <div class="main-content-area">
            <div class="machine-groups-column">
                @if (GroupedMachines.Count == 0 && TotalMachines > 0)
                {
                    <MudAlert Severity="Severity.Info" Class="my-2">@Loc["FiltreSonucuYok"]</MudAlert>
                }
                else if (TotalMachines == 0)
                {
                    <MudAlert Severity="Severity.Warning" Class="my-2">@Loc["MakineTanimlanmamis"]</MudAlert>
                }
                else
                {
                    @foreach (var group in GroupedMachines)
                    {
                        <div class="machine-group-box" style="--group-color: @GetGroupColor(group.Key)">
                            <div class="group-title">@group.Key</div>
                            <div class="group-inner-panel" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                @foreach (var machineStatus in group)
                                {
                                    <DashboardMachineCard MachineStatus="machineStatus"
                                                          @key="machineStatus.MachineId"
                                                          MouseClick="() => NavigateToDetail(machineStatus.MachineId)" />
                                }
                            </div>
                        </div>
                    }
                }
            </div>

            <div class="sidebar-charts-column pl-2" style="min-width: 300px;">
                <MudPaper Class="chart-box pa-2 mb-2" Elevation="2" Style="background-color: #1e1e2d;">
                    <div id="oeeChartContainer" style="width:100%; height:250px;"></div>
                    @if (!HourlyOeeData.Any())
                    {
                        <MudText Typo="Typo.caption" Align="Align.Center" Class="d-block text-muted">@Loc["OeeVerisiYok"]</MudText>
                    }
                </MudPaper>

                <MudPaper Class="chart-box pa-2 mb-2" Elevation="2" Style="background-color: #1e1e2d;">
                    <div id="electricChartContainer" style="width:100%; height:250px;"></div>
                </MudPaper>

                <MudPaper Class="chart-box pa-2 mb-2" Elevation="2" Style="background-color: #1e1e2d;">
                    <div id="waterChartContainer" style="width:100%; height:250px;"></div>
                </MudPaper>

                <MudPaper Class="chart-box pa-2 mb-2" Elevation="2" Style="background-color: #1e1e2d;">
                    <div id="steamChartContainer" style="width:100%; height:250px;"></div>
                </MudPaper>

                <MudPaper Class="chart-box pa-2 mb-2" Elevation="2" Style="background-color: #1e1e2d;">
                    <div id="topAlarmsChartContainer" style="width:100%; height:250px;"></div>
                </MudPaper>
            </div>
        </div>
    }
</div>

@* STİLLER *@
<style>
    /* Filtre checkbox yazılarının koyu zeminde okunması için */
    .filter-checkbox .mud-checkbox-label {
        color: #e0e0e0 !important;
    }

    /* Kartların BEYAZ arka plana sahip olmasını zorla */
    /* ::deep kullanımı, alt bileşenlerdeki (DashboardMachineCard) stilleri ezmemizi sağlar */
    ::deep .machine-card-hover {
        background-color: #ffffff !important; /* Arka plan kesinlikle beyaz */
        color: rgba(0,0,0, 0.87) !important; /* Yazılar siyah */
    }
</style>

@code {
    [Inject] public IJSRuntime JSRuntime { get; set; }

    private List<IGrouping<string, FullMachineStatus>> GroupedMachines = new();
    private bool _isLoading = true;
    private bool _isDisposed = false;
    private bool _shouldRenderCharts = false;

    // Kullanıcının dilini saklamak için değişken (Dashboard düzeltmesi)
    private CultureInfo _userCulture;

    // Filtreleme Durumu
    private bool _isFilterVisible = false;

    public class MachineSelectionModel
    {
        public int MachineId { get; set; }
        public string MachineName { get; set; }
    }

    private List<MachineSelectionModel> AllMachines = new();
    private HashSet<int> SelectedMachineIds = new HashSet<int>();

    // Grafik Verileri
    private List<HourlyConsumptionData> HourlyConsumptionData = new();
    private List<HourlyOeeData> HourlyOeeData = new();
    private List<TopAlarmData> TopAlarms = new();

    // KPI Alanları
    private int TotalMachines = 0;
    private int RunningMachines = 0;
    private int AlarmMachines = 0;
    private int IdleMachines = 0;

    private readonly List<string> DarkColors = new List<string>
    {
        "#2c3e50", "#2ecc71", "#e74c3c", "#9b59b6", "#3498db",
        "#f1c40f", "#16a085", "#c0392b", "#2980b9", "#f39c12",
    };
    private Dictionary<string, string> GroupColors = new Dictionary<string, string>();
    private int _colorIndex = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 1. ADIM: Kullanıcı dilini başlatırken kaydet
            _userCulture = CultureInfo.CurrentUICulture;

            await ScadaService.InitializeAsync();
            await ScadaService.GetMachinesAsync();
            ScadaService.OnDataUpdated += HandleDataUpdate;

            await LoadAllMachinesForSelection();
            await LoadSidebarDataAsync();
            UpdateDashboardData();

            _isLoading = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Grup İzleme Hatası: {ex.Message}");
            _isLoading = false;
        }

        await base.OnInitializedAsync();
    }

    private void ToggleFilterVisibility()
    {
        _isFilterVisible = !_isFilterVisible;
    }

    private async Task LoadAllMachinesForSelection()
    {
        AllMachines = ScadaService.MachineData.Values
            .Select(s => new MachineSelectionModel { MachineId = s.MachineId, MachineName = s.MachineName })
            .OrderBy(m => m.MachineName)
            .ToList();

        SelectedMachineIds = new HashSet<int>(AllMachines.Select(m => m.MachineId));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_shouldRenderCharts)
        {
            _shouldRenderCharts = false;
            try
            {
                await JSRuntime.InvokeVoidAsync("plotDashboardCharts",
                    HourlyOeeData,
                    HourlyConsumptionData,
                    TopAlarms);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"JS Grafik Hatası: {ex.Message}");
            }
        }
    }

    private async Task LoadSidebarDataAsync()
    {
        HourlyConsumptionData = await ScadaService.GetHourlyConsumptionAsync() ?? new();
        HourlyOeeData = await ScadaService.GetHourlyOeeAsync() ?? new();
        TopAlarms = await ScadaService.GetTopAlarmsAsync() ?? new();
        _shouldRenderCharts = true;
    }

    private void ToggleMachineSelection(int machineId, bool isSelected)
    {
        if (isSelected) SelectedMachineIds.Add(machineId);
        else SelectedMachineIds.Remove(machineId);
    }

    private void ApplyFilter()
    {
        UpdateDashboardData();
        StateHasChanged();
    }

    private void SelectAllMachines()
    {
        SelectedMachineIds = new HashSet<int>(AllMachines.Select(m => m.MachineId));
        UpdateDashboardData();
        StateHasChanged();
    }

    private void ClearSelection()
    {
        SelectedMachineIds.Clear();
        UpdateDashboardData();
        StateHasChanged();
    }

    private void NavigateToDetail(int machineId)
    {
        NavManager.NavigateTo($"/proseskontrol/{machineId}");
    }

    private void UpdateDashboardData()
    {
        var filteredStatuses = ScadaService.MachineData.Values
            .Where(s => SelectedMachineIds.Contains(s.MachineId))
            .ToList();

        foreach (var status in filteredStatuses)
        {
            if (ScadaService.MachineDetailsCache.TryGetValue(status.MachineId, out var machineDetails))
            {
                status.MakineTipi = machineDetails.MachineSubType;
            }
        }

        TotalMachines = filteredStatuses.Count;
        RunningMachines = filteredStatuses.Count(s => s.IsInRecipeMode && !s.HasActiveAlarm);
        AlarmMachines = filteredStatuses.Count(s => s.HasActiveAlarm);
        IdleMachines = TotalMachines - RunningMachines - AlarmMachines;

        var sortedMachines = filteredStatuses
            .OrderByDescending(m => m.HasActiveAlarm)
            .ThenByDescending(m => m.IsInRecipeMode)
            .ThenBy(m => m.MachineName);

        GroupedMachines = sortedMachines
            .GroupBy(m => string.IsNullOrEmpty(m.MakineTipi) ? "Diğer" : m.MakineTipi)
            .OrderByDescending(g => g.Any(m => m.IsInRecipeMode || m.HasActiveAlarm))
            .ThenBy(g => g.Key)
            .ToList();

        if (GroupColors.Count != GroupedMachines.Count)
        {
            _colorIndex = 0;
            GroupColors.Clear();
            foreach (var group in GroupedMachines)
            {
                GroupColors.TryAdd(group.Key, DarkColors[_colorIndex % DarkColors.Count]);
                _colorIndex++;
            }
        }
    }

    private void HandleDataUpdate()
    {
        try
        {
            if (_isDisposed) return;

            // 2. ADIM: Güncelleme geldiğinde dili zorla
            if (_userCulture != null)
            {
                CultureInfo.CurrentCulture = _userCulture;
                CultureInfo.CurrentUICulture = _userCulture;
            }

            UpdateDashboardData();
            _shouldRenderCharts = true;
            InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Grup İzleme Update Hatası: {ex.Message}");
        }
    }

    private string GetGroupColor(string groupKey)
    {
        return GroupColors.TryGetValue(groupKey, out var color) ? color : "#6c757d";
    }

    public void Dispose()
    {
        _isDisposed = true;
        ScadaService.OnDataUpdated -= HandleDataUpdate;
    }
}