@page "/proses-kontrol"
@rendermode InteractiveServer
@using TekstilScada.Services
@using TekstilScada.Models
@using TekstilScada.WebApp.Services
@using TekstilScada.WebApp.Components.Shared
@inject ScadaDataService ScadaDataService
@inject IJSRuntime JSRuntime
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Proses Kontrol</PageTitle>

<MudGrid Class="h-100">
    <MudItem xs="12" md="3" Class="d-flex flex-column gap-2">
        <MudPaper Elevation="3" Class="pa-3 flex-grow-1 d-flex flex-column" Style="height: calc(100vh - 100px);">
            <MudText Typo="Typo.h6" Class="mb-2">Reçeteler</MudText>

            <MudSelect T="int" Label="Hedef Makine (Filtre)" @bind-Value="SelectedMachineId" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-3" AnchorOrigin="Origin.BottomCenter">
                <MudSelectItem Value="0">Tümü / Seçiniz</MudSelectItem>
                @if (machines != null)
                {
                    foreach (var machine in machines)
                    {
                        <MudSelectItem Value="@machine.Id">@machine.MachineName</MudSelectItem>
                    }
                }
            </MudSelect>

            <MudButtonGroup Color="MudBlazor.Color.Primary" Variant="Variant.Outlined" Class="mb-3 w-100">
                <MudButton StartIcon="@Icons.Material.Filled.Add" OnClick="AddNewRecipe" Disabled="@(selectedMachine == null)">Yeni</MudButton>
                <MudButton StartIcon="@Icons.Material.Filled.Delete" Color="MudBlazor.Color.Error" OnClick="DeleteSelectedRecipe" Disabled="@(selectedRecipe == null)">Sil</MudButton>
                <MudButton StartIcon="@Icons.Material.Filled.Refresh" Color="MudBlazor.Color.Secondary" OnClick="LoadRecipes">Yenile</MudButton>
            </MudButtonGroup>

            <MudList T="string" Clickable="true" Dense="true" Class="flex-grow-1 overflow-auto border rounded">
                @if (isBusy && recipes == null)
                {
                    <MudListItem T="string"><MudProgressCircular Indeterminate="true" Size="MudBlazor.Size.Small" /></MudListItem>
                }
                else if (filteredRecipes != null)
                {
                    foreach (var recipe in filteredRecipes)
                    {
                        <MudListItem T="string"
                                     Text="@recipe.RecipeName"
                                     OnClick="() => SelectRecipe(recipe.Id, true)"
                                     Class="@(selectedRecipe?.Id == recipe.Id ? "mud-theme-primary text-white rounded" : "")" />
                    }
                }
            </MudList>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="9">
        <MudPaper Elevation="3" Class="pa-4 h-100">
            @if (selectedRecipe == null)
            {
                <div class="d-flex flex-column align-center justify-center h-100" style="opacity:0.5">
                    <MudIcon Icon="@Icons.Material.Filled.EditNote" Size="MudBlazor.Size.Large" style="font-size: 5rem;" />
                    <MudText Typo="Typo.h5" Class="mt-3">Düzenlemek için bir reçete seçin</MudText>

                    <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Info" StartIcon="@Icons.Material.Filled.CloudSync" OnClick="OpenFtpSync" Class="mt-4">
                        FTP SENKRONİZASYON MERKEZİ
                    </MudButton>
                </div>
            }
            else
            {
                <MudGrid Class="mb-4 align-center">
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="selectedRecipe.RecipeName" Label="Reçete Adı" Variant="Variant.Outlined" Margin="Margin.Dense" />
                    </MudItem>
                    <MudItem xs="12" md="6" Class="d-flex justify-end gap-2">
                        <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Primary" StartIcon="@Icons.Material.Filled.Save" OnClick="SaveCurrentRecipe" Disabled="@isBusy">KAYDET</MudButton>

                        <MudMenu Label="İŞLEMLER" Variant="Variant.Filled" Color="MudBlazor.Color.Info" EndIcon="@Icons.Material.Filled.KeyboardArrowDown">
                            <MudMenuItem OnClick="SendToPlc" Icon="@Icons.Material.Filled.Upload" Disabled="@(SelectedMachineId == 0)">Seçili Makineye Gönder</MudMenuItem>
                            <MudMenuItem OnClick="ReadFromPlc" Icon="@Icons.Material.Filled.Download" Disabled="@(SelectedMachineId == 0)">Seçili Makineden Oku</MudMenuItem>
                            <MudDivider />
                            <MudMenuItem OnClick="OpenFtpSync" Icon="@Icons.Material.Filled.CloudSync">FTP / Çoklu Gönderim</MudMenuItem>
                        </MudMenu>
                    </MudItem>
                </MudGrid>

                <MudDivider Class="mb-4" />

                @if (selectedMachine?.MachineType == "Kurutma Makinesi")
                {
                    <KurutmaReceteEditor Recipe="selectedRecipe" OnChanged="RefreshStepList" />
                }
                else
                {
                    <MudGrid>
                        <MudItem xs="12" md="3">
                            <MudPaper Class="border pa-2" Style="max-height: 500px; overflow-y: auto;">
                                <MudText Typo="Typo.subtitle2" Align="MudBlazor.Align.Center" Class="mb-2">ADIMLAR</MudText>
                                <MudList T="string" Clickable="true" Dense="true">
                                    @foreach (var step in selectedRecipe.Steps.OrderBy(s => s.StepNumber))
                                    {
                                        <MudListItem T="string" OnClick="() => selectedStep = step"
                                                     Class="@(selectedStep?.StepNumber == step.StepNumber ? "mud-theme-primary text-white rounded mb-1" : "mb-1")">
                                            <div class="d-flex justify-space-between w-100">
                                                <b>@step.StepNumber.</b>
                                                <span>@GetStepTypeName(step)</span>
                                            </div>
                                        </MudListItem>
                                    }
                                </MudList>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" md="9">
                            @if (selectedStep != null)
                            {
                                <StepEditor Step="selectedStep"
                                            MachineSubType="@(GetMachineFilterType(selectedMachine))"
                                            OnChanged="RefreshStepList" />
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info" Variant="Variant.Filled">Düzenlemek için soldan bir adım seçiniz.</MudAlert>
                            }
                        </MudItem>
                    </MudGrid>
                }
            }
        </MudPaper>
    </MudItem>
</MudGrid>



@code {
    private List<ScadaRecipe>?
 recipes;
    private List<ScadaRecipe> filteredRecipes = new();
    private List<Machine>? machines;
    private ScadaRecipe? selectedRecipe; // Sayfa açılışında null
    private ScadaRecipeStep? selectedStep;
    private int selectedMachineId; // Sayfa açılışında 0
    private bool isBusy = false;
    private string statusMessage = string.Empty;
    private bool showFtpModal = false;

    private Machine?
 selectedMachine;

    // YENİ: FTP Penceresini Açma Metodu
    private async Task OpenFtpSync()
    {
        if (recipes == null || machines == null)
        {
            Snackbar.Add("Veriler henüz yüklenmedi, lütfen bekleyin.", Severity.Warning);
            return;
        }

        var parameters = new DialogParameters<FtpSyncModal>
        {
            { x => x.LocalRecipes, recipes },
            { x => x.AllMachines, machines },
            { x => x.InitialTargetType, selectedRecipe?.TargetMachineType ?? "" }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.ExtraLarge,
            FullWidth = true,
            CloseButton = true,
            // DÜZELTME: DisableBackdropClick yerine BackdropClick = false kullanılıyor (MudBlazor v7+)
            BackdropClick = false
        };

        var dialog = await DialogService.ShowAsync<FtpSyncModal>("FTP Senkronizasyon Merkezi", parameters, options);
    }
    private string GetMachineFilterType(Machine? machine)
    {
        if (machine == null) return string.Empty;
        return string.IsNullOrEmpty(machine.MachineSubType) ? machine.MachineType : machine.MachineSubType;
    }

    private int SelectedMachineId
    {
        get => selectedMachineId;
        set
        {
            if (selectedMachineId == value) return;

            selectedMachineId = value;
            selectedMachine = machines?.FirstOrDefault(m => m.Id == value);

            // Makine değiştiğinde, reçete listesini filtrele. Otomatik seçim, filtreleme mantığı içinde yapılacak.
            FilterRecipesByMachine(autoSelectFirst: false); // FALSE: Sadece filtrele, ilkini seçme
        }
    }

    protected override async Task OnInitializedAsync()
    {
        isBusy = true;
        statusMessage = "Bileşenler yükleniyor...";

        // 1. Makineler yükleniyor (selectedMachineId = 0 olarak kalır)
        await LoadMachines();

        // 2. Reçeteler yükleniyor
       await LoadRecipes();
        isBusy = false;

        // 3. İlk filtrelemeyi yap. Sayfa boş açılsın diye selectedRecipe = null
        selectedRecipe = null;
        selectedStep = null;

        // Tüm reçeteleri göster (makine seçimi 0 olduğu için)
        FilterRecipesByMachine(autoSelectFirst: false);

        StateHasChanged();
    }

    private async Task LoadMachines()
    {
        machines = await ScadaDataService.GetMachinesAsync();
        if (machines != null && machines.Any())
        {
            // İlk yüklemede, varsayılan makine seçilmeyecek, sadece listeyi dolduracağız.
            // selectedMachineId = 0 olarak kalır.
        }
        else
        {
            selectedMachineId = 0;
            selectedMachine = null;
        }
    }

    private async Task LoadRecipes()
    {
        isBusy = true;

        recipes = await ScadaDataService.GetRecipesAsync();
        StateHasChanged();
        FilterRecipesByMachine(autoSelectFirst: false);
        isBusy = false;
    }

    private void FilterRecipesByMachine(bool autoSelectFirst = false)
    {
        // Filtrelemeden önce her zaman mevcut seçimi temizle
        selectedRecipe = null;
        selectedStep = null;

        // 0. Hiç makine seçilmediyse, tüm reçeteleri göster (filtresiz)
       if (SelectedMachineId == 0 || machines == null || recipes == null)
       {
           filteredRecipes = new List<ScadaRecipe>();
           StateHasChanged();
           return;
      }

        var machine = machines.FirstOrDefault(m => m.Id == SelectedMachineId);
        if (machine == null)
        {
            filteredRecipes = recipes;
            StateHasChanged();
            return;
        }

        // 1. Makineye göre filtrele
        string filterType = GetMachineFilterType(machine);

        filteredRecipes = recipes.Where(r => r.TargetMachineType == filterType).ToList();

        // 2. İsteğe bağlı olarak ilk reçeteyi seç (Yani makineyi seçtiğinde, reçete varsa detaylar gelsin)
        if (autoSelectFirst && filteredRecipes.Any())
        {
            var firstRecipe = filteredRecipes.First();
            selectedRecipe = firstRecipe;
        }

        StateHasChanged();
    }

    private void AddNewRecipe()
    {
        selectedStep = null;
        if (selectedMachine == null)
        {
            statusMessage = "Lütfen önce hedef makineyi seçin.";
            return;
        }

        string targetType = GetMachineFilterType(selectedMachine);

        selectedRecipe = new ScadaRecipe
        {
            RecipeName = "YENİ REÇETE",
            TargetMachineType = targetType
        };

        int stepCount = (selectedMachine?.MachineType == "Kurutma Makinesi") ?
 1 : 98;

        selectedRecipe.Steps.Clear();
        for (int i = 1; i <= stepCount; i++)
        {
            selectedRecipe.Steps.Add(new ScadaRecipeStep { StepNumber = i, StepDataWords = new short[25] });
        }
        statusMessage = "Yeni reçete oluşturuldu.";
        StateHasChanged();
    }

    private void RefreshStepList() => StateHasChanged();

    private async Task SelectRecipe(int recipeId, bool isFromList = false)
    {
        if (selectedRecipe?.Id == recipeId && isFromList) return;

        isBusy = true;
        statusMessage = "Reçete detayları yükleniyor...";
        selectedStep = null;

        selectedRecipe = await ScadaDataService.GetRecipeDetailsAsync(recipeId);

        isBusy = false;

        if (selectedRecipe != null && selectedMachine != null)
        {
            selectedRecipe.TargetMachineType = GetMachineFilterType(selectedMachine);
        }

        StateHasChanged();
    }

    private async Task SaveCurrentRecipe()
    {
        if (selectedRecipe == null) return;
        if (string.IsNullOrWhiteSpace(selectedRecipe.RecipeName))
        {
            statusMessage = "Reçete adı boş olamaz.";
            return;
        }

        if (selectedMachine != null && selectedRecipe.TargetMachineType != GetMachineFilterType(selectedMachine))
        {
            await JSRuntime.InvokeVoidAsync("alert", $"HATA: Reçete tipi ({selectedRecipe.TargetMachineType}) seçili makine tipiyle ({GetMachineFilterType(selectedMachine)}) eşleşmiyor. Lütfen yeni bir reçete oluşturun veya makine tipini değiştirin.");
            return;
        }

        isBusy = true;
        statusMessage = "Reçete kaydediliyor...";
        StateHasChanged();

        try
        {
            var savedRecipe = await ScadaDataService.SaveRecipeAsync(selectedRecipe);
            if (savedRecipe != null)
            {
                selectedRecipe = savedRecipe;
                await LoadRecipes();
                FilterRecipesByMachine(autoSelectFirst: false);
                statusMessage = "Reçete başarıyla kaydedildi.";
                await JSRuntime.InvokeVoidAsync("alert", "Reçete başarıyla kaydedildi.");
            }
            else
            {
                statusMessage = "Kaydetme başarısız oldu. API hatası.";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Kaydetme sırasında hata: {ex.Message}";
        }
        finally
        {
            isBusy = false;
            StateHasChanged();
        }
    }

    private async Task DeleteSelectedRecipe()
    {
        if (selectedRecipe == null) return;

        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"'{selectedRecipe.RecipeName}' reçetesini silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.");

        if (!confirmed) return;

        isBusy = true;
        statusMessage = "Reçete siliniyor...";
        StateHasChanged();

        try
        {
            bool success = await ScadaDataService.DeleteRecipeAsync(selectedRecipe.Id);

            if (success)
            {
                selectedRecipe = null;
                selectedStep = null;
                await LoadRecipes();
                FilterRecipesByMachine(autoSelectFirst: true);
                statusMessage = "Reçete başarıyla silindi.";
                await JSRuntime.InvokeVoidAsync("alert", "Reçete başarıyla silindi.");
            }
            else
            {
                statusMessage = "Silme başarısız oldu. API hatası.";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Silme sırasında hata: {ex.Message}";
        }
        finally
        {
            isBusy = false;
            StateHasChanged();
        }
    }

   
        private async Task SendToPlc()
    {
        if (selectedRecipe == null || selectedMachine == null) return;

        // Makine tipine göre işlem
        if (selectedMachine.MachineType == "BYMakinesi")
        {
            // BY Makinesi için Numara Girme Dialogu
            // MudBlazor Dialog servisini kullanabiliriz veya basit bir JS prompt
            // Şimdilik basitlik için JS prompt kullanalım
            string recipeNoStr = await JSRuntime.InvokeAsync<string>("prompt", "HMI Reçete Numarası Giriniz (1-99):");

            if (int.TryParse(recipeNoStr, out int recipeNo) && recipeNo >= 1 && recipeNo <= 99)
            {
                isBusy = true;
                StateHasChanged();

                // İLERLEME GÖSTERİMİ (Snackbar ile)
                Snackbar.Add($"Reçete '{selectedMachine.MachineName}' makinesine gönderiliyor...", Severity.Info);

                try
                {
                    string remoteFileName = string.Format("XPR{0:D5}.csv", recipeNo);
                    bool success = await ScadaDataService.QueueReceiveJobsAsync(new List<string> { remoteFileName }, selectedMachine.Id); // Buradaki metot adını kontrol edin, Send için uygun olanı kullanın
                                                                                                                                          // Not: ScadaDataService'deki Send metodunu kullanmalısınız, örnekte QueueReceive var.
                                                                                                                                          // Doğrusu: await ScadaDataService.SendRecipeToPlcAsync(...) olmalı

                    // Simülasyon
                    await Task.Delay(1000);

                    Snackbar.Add("Gönderim Başarılı!", Severity.Success);
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
                }
                finally
                {
                    isBusy = false;
                    StateHasChanged();
                }
            }
        }
        else
        {
            // Diğer makineler için direk gönderim
            // ...
        }
    }

    private async Task ReadFromPlc()
    {
        if (selectedMachine == null) return;

        isBusy = true;
        statusMessage = $"Reçete '{selectedMachine.MachineName}' makinesinden okunuyor...";
        selectedRecipe = null;
        StateHasChanged();

        try
        {
            var recipeFromPlc = await ScadaDataService.ReadRecipeFromPlcAsync(selectedMachine.Id);

            if (recipeFromPlc != null)
            {
                recipeFromPlc.RecipeName = $"PLC_{selectedMachine.MachineUserDefinedId}_{DateTime.Now:HHmm}";
                recipeFromPlc.TargetMachineType = GetMachineFilterType(selectedMachine);
                selectedRecipe = recipeFromPlc;
                selectedStep = null;
                statusMessage = $"Reçete makineden başarıyla okundu. Yeni bir isim verip kaydedin.";
                await JSRuntime.InvokeVoidAsync("alert", statusMessage);
            }
            else
            {
                statusMessage = "PLC'den okuma başarısız oldu. Bağlantı/PLC hatası.";
                await JSRuntime.InvokeVoidAsync("alert", statusMessage);
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Okuma sırasında hata: {ex.Message}";
            await JSRuntime.InvokeVoidAsync("alert", statusMessage);
        }
        finally
        {
            isBusy = false;
            StateHasChanged();
        }
    }


    private string GetStepTypeName(ScadaRecipeStep step)
    {
        var stepTypes = new List<string>();
        short controlWord = step.StepDataWords.Length > 24 ? step.StepDataWords[24] : (short)0;
        if ((controlWord & 1) != 0) stepTypes.Add("Su Alma");
        if ((controlWord & 2) != 0) stepTypes.Add("Isıtma");
        if ((controlWord & 4) != 0) stepTypes.Add("Çalışma");
        if ((controlWord & 8) != 0) stepTypes.Add("Dozaj");
        if ((controlWord & 16) != 0) stepTypes.Add("Boşaltma");
        if ((controlWord & 32) != 0) stepTypes.Add("Sıkma");
        return stepTypes.Any() ? string.Join(" + ", stepTypes) : "";
    }
}