@* Dosya: TekstilScada.WebApp/Components/Pages/MachineCard.razor *@

@using TekstilScada.Models
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager NavigationManager

<div class="card machine-card-web @GetConnectionCssClass()" @onclick="@NavigateToDetail">
    <div class="card-header-web">
        <span class="machine-number" style="color: black;">@MachineStatus.MachineId.</span>
        <span class="machine-name-web" style="color: black;">@MachineStatus.MachineName</span>
        <div class="icons">
           

            <button type="button"
                    class="btn btn-sm btn-link icon info-icon"
                    style="color: black; text-decoration: none; padding: 0 10px;"
                    @onclick="HandleInfoButtonClick"
                    @onclick:stopPropagation="true">
                i
            </button>


            <span class="icon status-icon @GetConnectionCssClass()">@GetConnectionStatusIconText()</span>
        </div>
    </div>
    <div class="card-body-web">
        <div class="status-line">
            <span class="status-text @GetStatusCssClass()">@GetStatusText()</span>
            @if (MachineStatus.IsInRecipeMode)
            {
                <div class="progress-container">
                    <div class="progress-bar-web" style="width: @(MachineStatus.ProsesYuzdesi)%"></div>
                </div>
                <span style="color: black;">@MachineStatus.ProsesYuzdesi%</span>
            }
        </div>
        <div class="details-grid">
            <span style="color: black;">REÇETE ADI:</span> <span style="color: black;">@MachineStatus.RecipeName </span>
            <span style="color: black;">PARTİ NO:</span> <span style="color: black;">@MachineStatus.BatchNumarasi </span>
            <span style="color: black;">SICAKLIK:</span> <span style="color: black;">@GetFormattedTemperature()°C</span>
            <span style="color: black;">DEVİR (RPM):</span> <span style="color: black;">@MachineStatus.AnlikDevirRpm</span>
            <span style="color: black;">ADIM:</span> <span style="color: black;">@($"{MachineStatus.AktifAdimNo} - {MachineStatus.AktifAdimAdi}")</span>
            <span style="color: black;">OPERATÖR:</span> <span style="color: black;">@MachineStatus.OperatorIsmi </span>
        </div>
    </div>
</div>


@code {
    [Parameter] public Action<int>? OnInfoClickAction { get; set; } // Yeni parametre

    private void HandleInfoButtonClick()
    {
        OnInfoClickAction?.Invoke(MachineStatus.MachineId); // Invoke ile doğrudan çağır.
    }
    [Parameter]
    public FullMachineStatus MachineStatus { get; set; } = new();

    // DÜZELTME: OnClick artık MouseEventArgs almalıdır (HTML uyumluluğu için).
    [Parameter]
    public EventCallback<MouseEventArgs> OnClick { get; set; }

    // DÜZELTME: OnInfoClick MachineId (int) argümanını bekler.
    [Parameter]
    public EventCallback<int> OnInfoClick { get; set; }

    // YENİ METOT: 'i' butonuna tıklama olayını yakalar ve MachineId ile dışarı yollar.
    private async Task HandleInfoButtonClick(MouseEventArgs args)
    {
        // OnInfoClick'i MachineId ile invoke eder.
        await OnInfoClick.InvokeAsync(MachineStatus.MachineId);
    }

    private string GetConnectionCssClass()
    {
        return MachineStatus.ConnectionState switch
        {
            ConnectionStatus.Connected => "connected",
            ConnectionStatus.Connecting => "connecting",
            _ => "disconnected"
        };
    }

    private string GetStatusText()
    {
        if (MachineStatus.ConnectionState != ConnectionStatus.Connected) return "BAĞLANTI YOK";
        if (MachineStatus.HasActiveAlarm) return $"ALARM: {MachineStatus.ActiveAlarmNumber}";
        if (MachineStatus.IsPaused) return "DURAKLATILDI";
        if (MachineStatus.IsInRecipeMode) return $"ÇALIŞIYOR - ADIM {MachineStatus.AktifAdimNo}";
        return "DURUYOR";
    }

    private string GetStatusCssClass()
    {
        if (MachineStatus.HasActiveAlarm) return "status-alarm-text";
        if (MachineStatus.IsInRecipeMode) return "status-running-text";
        return "status-stopped-text";
    }

    private string GetFormattedTemperature()
    {
        return (MachineStatus.AnlikSicaklik / 10.0m).ToString("F1");
    }
    private void NavigateToDetail()
    {
        // Makine detay sayfasına yönlendirme
        NavigationManager.NavigateTo($"/makine-detay/{MachineStatus.MachineId}");
    }
    private string GetConnectionStatusIconText()
    {
        return MachineStatus.ConnectionState switch
        {
            ConnectionStatus.Connected => "C", // Bağlantı varsa
            ConnectionStatus.Connecting => "R", // Deneniyorsa
            ConnectionStatus.Disconnected => "D" // Bağlantı yoksa
        };
    }
}