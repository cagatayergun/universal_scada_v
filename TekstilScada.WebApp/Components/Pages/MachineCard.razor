@* Dosya: TekstilScada.WebApp/Components/Pages/MachineCard.razor *@

@using TekstilScada.Models
@using Microsoft.AspNetCore.Components.Web
@using MudBlazor
@using TekstilScada.Core.Localization
@using Microsoft.Extensions.Localization
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResource> Loc
@inject IDialogService DialogService
<MudCard Elevation="4" Class="ma-2 machine-card-hover" Style="@GetCardBorderStyle()">
    <MudCardHeader>
        <CardHeaderAvatar>
            <MudAvatar Color="@GetConnectionColor()" Variant="Variant.Filled" Size="Size.Medium">
                <MudText Typo="Typo.subtitle1"><b>@MachineStatus.MachineId</b></MudText>
            </MudAvatar>
        </CardHeaderAvatar>
        <CardHeaderContent>
            <MudText Typo="Typo.h6" Color="Color.Primary"><b>@MachineStatus.MachineName</b></MudText>
            <MudText Typo="Typo.caption">@MachineStatus.MachineId</MudText> @* <-- DÜZELTME: MachineId değil UserDefinedId *@
        </CardHeaderContent>
        <CardHeaderActions>
            <MudTooltip Text="@Loc["Detaylar"]">
                <MudIconButton Icon="@Icons.Material.Filled.Info"
                               Color="Color.Default"
                               OnClick="NavigateToDetail"
                               Disabled="@(MachineStatus.ConnectionState != ConnectionStatus.Connected)" />
            </MudTooltip>

            <MudTooltip Text="@Loc["VncIzle"]">
                <MudIconButton Icon="@Icons.Material.Filled.ScreenShare"
                               Color="Color.Info"
                               OnClick="() => OpenVncPopup(MachineStatus.MachineId)"
                               Target="_blank"
                               Disabled="@(MachineStatus.ConnectionState != ConnectionStatus.Connected)" />
            </MudTooltip>

            <MudTooltip Text="@GetConnectionStatusText()">
                <MudIcon Icon="@Icons.Material.Filled.Wifi"
                         Color="@GetConnectionColor()"
                         Class="ml-2" />
            </MudTooltip>
        </CardHeaderActions>
    </MudCardHeader>

    <MudDivider />

    <MudCardContent>
        <div class="d-flex justify-center mb-3">
            <MudChip T="string" Color="@GetStatusColor()" Variant="Variant.Filled" Class="w-100 justify-center">
                <MudIcon Icon="@GetStatusIcon()" Class="mr-2" />
                @GetStatusText()
            </MudChip>
        </div>

        @if (MachineStatus.IsInRecipeMode)
        {
            <div class="mb-4">
                <div class="d-flex justify-space-between">
                    <MudText Typo="Typo.caption">@Loc["Ilerleme"]</MudText>
                    <MudText Typo="Typo.caption"><b>%@MachineStatus.ProsesYuzdesi</b></MudText>
                </div>
                <MudProgressLinear Color="Color.Success"
                                   Value="@Convert.ToDouble(MachineStatus.ProsesYuzdesi)"
                                   Striped="true"
                                   Size="Size.Large"
                                   Class="rounded-lg" />
            </div>
        }

        <MudGrid Spacing="1">
            <MudItem xs="12">
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.ReceiptLong" Size="Size.Small" Color="Color.Default" />
                    <MudText Typo="Typo.body2" Style="font-weight:bold;">@Loc["Recete"]</MudText>
                    <MudText Typo="Typo.body2" Class="ml-auto text-truncate">@MachineStatus.RecipeName</MudText>
                </MudStack>
            </MudItem>

            <MudItem xs="6">
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.QrCode" Size="Size.Small" Color="Color.Default" />
                    <MudText Typo="Typo.caption">@Loc["Parti"]</MudText>
                    <MudText Typo="Typo.body2" Class="ml-auto"><b>@MachineStatus.BatchNumarasi</b></MudText>
                </MudStack>
            </MudItem>

            <MudItem xs="6">
                <MudStack Row="true" AlignItems="AlignItems.Center">
                    <MudIcon Icon="@Icons.Material.Filled.FormatListNumbered" Size="Size.Small" Color="Color.Default" />
                    <MudText Typo="Typo.caption">@Loc["Adim"]</MudText>
                    <MudText Typo="Typo.body2" Class="ml-auto"><b>@MachineStatus.AktifAdimNo</b></MudText>
                </MudStack>
            </MudItem>

            <MudItem xs="12"><MudDivider Class="my-1" /></MudItem>

            <MudItem xs="6">
                <div class="d-flex align-center justify-center flex-column pa-2 rounded mud-theme-primary-hover">
                    <MudIcon Icon="@Icons.Material.Filled.Thermostat" Color="Color.Error" />
                    <MudText Typo="Typo.h6">@GetFormattedTemperature()°C</MudText>
                    <MudText Typo="Typo.caption">@Loc["Sicaklik"]</MudText>
                </div>
            </MudItem>

            <MudItem xs="6">
                <div class="d-flex align-center justify-center flex-column pa-2 rounded mud-theme-primary-hover">
                    <MudIcon Icon="@Icons.Material.Filled.Speed" Color="Color.Warning" />
                    <MudText Typo="Typo.h6">@MachineStatus.AnlikDevirRpm</MudText>
                    <MudText Typo="Typo.caption">@Loc["Devir"]</MudText>
                </div>
            </MudItem>

            <MudItem xs="12" Class="d-flex justify-end mt-1">
                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-1" style="vertical-align:middle" />
                    @MachineStatus.OperatorIsmi
                </MudText>
            </MudItem>

        </MudGrid>
    </MudCardContent>
</MudCard>

<style>
    /* Hafif bir hover efekti ekleyelim */
    .machine-card-hover {
        transition: all 0.3s ease;
    }

        .machine-card-hover:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15) !important;
        }
</style>

@code {
    [Parameter] public Action<int>? OnInfoClickAction { get; set; }
    [Parameter] public FullMachineStatus MachineStatus { get; set; } = new();
    [Parameter] public EventCallback<MouseEventArgs> OnClick { get; set; }
    [Parameter] public EventCallback<int> OnInfoClick { get; set; }

    private Color GetConnectionColor()
    {
        return MachineStatus.ConnectionState switch
        {
            ConnectionStatus.Connected => Color.Success,
            ConnectionStatus.Connecting => Color.Warning,
            _ => Color.Error
        };
    }

    private string GetConnectionStatusText()
    {
        return MachineStatus.ConnectionState switch
        {
            ConnectionStatus.Connected => Loc["Bagli"],
            ConnectionStatus.Connecting => Loc["Baglaniyor"],
            _ => Loc["BaglantiYok"]
        };
    }

    private string GetStatusText()
    {
        if (MachineStatus.ConnectionState != ConnectionStatus.Connected) return Loc["BaglantiKoptu"];
        if (MachineStatus.HasActiveAlarm) return $"{Loc["Alarm"]}: {MachineStatus.ActiveAlarmNumber}";
        if (MachineStatus.IsPaused) return Loc["Durakladi"];
        if (MachineStatus.IsInRecipeMode) return $"{Loc["Calisiyor"]} - {MachineStatus.AktifAdimAdi}";
        return Loc["Bosta"];
    }

    private Color GetStatusColor()
    {
        if (MachineStatus.ConnectionState != ConnectionStatus.Connected) return Color.Dark;
        if (MachineStatus.HasActiveAlarm) return Color.Error;
        if (MachineStatus.IsPaused) return Color.Warning;
        if (MachineStatus.IsInRecipeMode) return Color.Success;
        return Color.Info;
    }

    private string GetStatusIcon()
    {
        if (MachineStatus.ConnectionState != ConnectionStatus.Connected) return Icons.Material.Filled.WifiOff;
        if (MachineStatus.HasActiveAlarm) return Icons.Material.Filled.NotificationImportant;
        if (MachineStatus.IsPaused) return Icons.Material.Filled.PauseCircle;
        if (MachineStatus.IsInRecipeMode) return Icons.Material.Filled.PlayCircle;
        return Icons.Material.Filled.StopCircle;
    }

    // Alarm durumunda kartın kenarlığını kırmızı yapmak için stil
    private string GetCardBorderStyle()
    {
        if (MachineStatus.HasActiveAlarm)
            return "border: 2px solid var(--mud-palette-error); animation: pulse-red 2s infinite;";
        return "";
    }

    private string GetFormattedTemperature()
    {
        return (MachineStatus.AnlikSicaklik / 10.0m).ToString("F1");
    }

    private async Task HandleInfoButtonClick(MouseEventArgs args)
    {
        OnInfoClickAction?.Invoke(MachineStatus.MachineId);
        await OnInfoClick.InvokeAsync(MachineStatus.MachineId);
    }

    private void NavigateToDetail()
    {
        NavigationManager.NavigateTo($"/makine-detay/{MachineStatus.MachineId}");
    }
    private async Task OpenVncPopup(int machineId)
    {
        try
        {
            var parameters = new DialogParameters { ["MachineId"] = machineId };

            var options = new DialogOptions
            {
                MaxWidth = MaxWidth.ExtraLarge,
                FullWidth = true,
                CloseButton = true,
                BackdropClick = false,
                NoHeader = false
            };

            var dialog = await DialogService.ShowAsync<VncMonitorDialog>("", parameters, options);
            // Sonucu beklemek zorunda değilseniz bu satırı kaldırabilirsiniz, bazen kilitlenmeye sebep olabilir.
            // var result = await dialog.Result;
        }
        catch (Exception ex)
        {
            //($"Dialog Hatası: {ex.Message}");
            // Gerekirse kullanıcıya Snackbar ile hata gösterilebilir.
        }
    }
}