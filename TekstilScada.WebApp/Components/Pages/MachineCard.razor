@* Dosya: TekstilScada.WebApp/Components/Pages/MachineCard.razor *@

@using TekstilScada.Models
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager NavigationManager

<div class="card machine-card-web @GetConnectionCssClass()">
    <div class="card-header-web">
        <span class="machine-number" style="color: black;">@MachineStatus.MachineId.</span>
        <span class="machine-name-web" style="color: black;">@MachineStatus.MachineName</span>

        <div class="icons">
            <button type="button"
                    class="btn btn-sm btn-link icon info-icon"
                    style="color: black; text-decoration: none; padding: 0 10px;"
                    @onclick="NavigateToDetail"
                    @onclick:stopPropagation="true">
                i
            </button>

            <span @onclick:stopPropagation="true">
                <MudTooltip Text="Ekranı İzle (VNC)">
                    <MudIconButton Icon="@Icons.Material.Filled.ScreenShare"
                                   Size="MudBlazor.Size.Large"
                                   Color="MudBlazor.Color.Info"
                                   Href="@($"/vnc/{MachineStatus.MachineId}")"
                                   Target="_blank"
                                   Disabled="@(MachineStatus.ConnectionState != ConnectionStatus.Connected)" />
                </MudTooltip>
            </span>
            <span class="icon status-icon @GetConnectionCssClass()">@GetConnectionStatusIconText()</span>
        </div>
    </div>

    <div class="card-body-web">
        <div class="status-line">
            <span class="status-text @GetStatusCssClass()">@GetStatusText()</span>
            @if (MachineStatus.IsInRecipeMode)
            {
                <div class="progress-container">
                    <div class="progress-bar-web" style="width: @(MachineStatus.ProsesYuzdesi)%"></div>
                </div>
                <span style="color: black;">@MachineStatus.ProsesYuzdesi%</span>
            }
        </div>
        <div class="details-grid">
            <span style="color: black;">REÇETE ADI:</span> <span style="color: black;">@MachineStatus.RecipeName </span>
            <span style="color: black;">PARTİ NO:</span> <span style="color: black;">@MachineStatus.BatchNumarasi </span>
            <span style="color: black;">SICAKLIK:</span> <span style="color: black;">@GetFormattedTemperature()°C</span>
            <span style="color: black;">DEVİR (RPM):</span> <span style="color: black;">@MachineStatus.AnlikDevirRpm</span>
            <span style="color: black;">ADIM:</span> <span style="color: black;">@($"{MachineStatus.AktifAdimNo} - {MachineStatus.AktifAdimAdi}")</span>
            <span style="color: black;">OPERATÖR:</span> <span style="color: black;">@MachineStatus.OperatorIsmi </span>
        </div>

    </div>
</div>

@code {
    [Parameter] public Action<int>? OnInfoClickAction { get; set; }

    [Parameter]
    public FullMachineStatus MachineStatus { get; set; } = new();

    [Parameter]
    public EventCallback<MouseEventArgs> OnClick { get; set; }

    [Parameter]
    public EventCallback<int> OnInfoClick { get; set; }

    // Kodunuzda iki tane HandleInfoButtonClick vardı, ikisini birleştirmek daha sağlıklı olur:
    private async Task HandleInfoButtonClick(MouseEventArgs args)
    {
        // Hem Action'ı hem EventCallback'i tetikler
        OnInfoClickAction?.Invoke(MachineStatus.MachineId);
        await OnInfoClick.InvokeAsync(MachineStatus.MachineId);
    }

    private string GetConnectionCssClass()
    {
        return MachineStatus.ConnectionState switch
        {
            ConnectionStatus.Connected => "connected",
            ConnectionStatus.Connecting => "connecting",
            _ => "disconnected"
        };
    }

    private string GetStatusText()
    {
        if (MachineStatus.ConnectionState != ConnectionStatus.Connected) return "BAĞLANTI YOK";
        if (MachineStatus.HasActiveAlarm) return $"ALARM: {MachineStatus.ActiveAlarmNumber}";
        if (MachineStatus.IsPaused) return "DURAKLATILDI";
        if (MachineStatus.IsInRecipeMode) return $"ÇALIŞIYOR - ADIM {MachineStatus.AktifAdimNo}";
        return "DURUYOR";
    }

    private string GetStatusCssClass()
    {
        if (MachineStatus.HasActiveAlarm) return "status-alarm-text";
        if (MachineStatus.IsInRecipeMode) return "status-running-text";
        return "status-stopped-text";
    }

    private string GetFormattedTemperature()
    {
        return (MachineStatus.AnlikSicaklik / 10.0m).ToString("F1");
    }

    // Bu metod artık kart tıklanmasıyla çalışmıyor.
    // Eğer detay sayfasına gitmek istiyorsanız yukarıdaki HTML'e yeni bir buton ekleyip bu metodu ona bağlayın.
    private void NavigateToDetail()
    {
        NavigationManager.NavigateTo($"/makine-detay/{MachineStatus.MachineId}");
    }

    private string GetConnectionStatusIconText()
    {
        return MachineStatus.ConnectionState switch
        {
            ConnectionStatus.Connected => "C",
            ConnectionStatus.Connecting => "R",
            ConnectionStatus.Disconnected => "D"
        };
    }
}