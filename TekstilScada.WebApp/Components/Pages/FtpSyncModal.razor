@using TekstilScada.Models
@using TekstilScada.Services
@using TekstilScada.WebApp.Services
@using System.Collections.Concurrent
@using MudBlazor

@inject ScadaDataService ScadaDataService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<MudDialog DisableSidePadding="true" MaxWidth="MaxWidth.False" Style="width:95vw; height:90vh;">
    <DialogContent>
        <MudContainer Style="height: 100%; max-height:100%; overflow:hidden;" Class="pa-2">
            <MudGrid Style="height: 100%;" Spacing="2">

                <MudItem xs="12" md="8" Style="height: 100%;">
                    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-3" Style="height: 100%; background-color: white; overflow:hidden;">

                        <MudTabPanel Text="Reçete Gönder (PC -> Makine)" Icon="@Icons.Material.Filled.CloudUpload" Style="height: 100%;">
                            <MudGrid Spacing="3">

                                <MudItem xs="12" md="5">

                                    <div class="mb-2">
                                        <MudText Typo="Typo.subtitle2" Color="MudBlazor.Color.Primary" Class="mb-1"><b>1. Adım: Reçete Seçimi</b></MudText>
                                        <MudSelect T="string" Label="Reçete Tipi" Value="@_filterType" ValueChanged="OnFilterTypeChanged" Dense="true" Variant="Variant.Outlined" Margin="Margin.Dense">
                                            @foreach (var type in _availableTypes)
                                            {
                                                <MudSelectItem Value="@type">@type</MudSelectItem>
                                            }
                                        </MudSelect>
                                    </div>

                                    <MudPaper Elevation="0" Outlined="true" Class="d-flex flex-column border-2 mud-border-primary"
                                              Style="height: 60vh; overflow-y: auto; overflow-x: hidden;">
                                        <MudDataGrid T="ScadaRecipe"
                                                     Items="@_filteredRecipes"
                                                     MultiSelection="true"
                                                     @bind-SelectedItems="_selectedRecipes"
                                                     Dense="true"
                                                     Hover="true"
                                                     Bordered="true"
                                                     FixedHeader="true"
                                                     Virtualize="true"
                                                     Height="100%">
                                            <Columns>
                                                <SelectColumn T="ScadaRecipe" />
                                                <PropertyColumn Property="x => x.RecipeName" Title="Reçete Adı" />
                                            </Columns>
                                        </MudDataGrid>
                                    </MudPaper>

                                    <MudText Typo="Typo.caption" Class="mt-1">@(_selectedRecipes.Count) reçete seçildi.</MudText>
                                </MudItem>

                                <MudItem xs="12" md="7">

                                    <div class="mb-2">
                                        <MudText Typo="Typo.subtitle2" Color="MudBlazor.Color.Secondary" Class="mb-1"><b>2. Adım: Hedef Seçimi</b></MudText>
                                    </div>

                                    <MudPaper Elevation="0" Outlined="true" Class="d-flex flex-column border-2 mud-border-secondary"
                                              Style="height: 50vh; overflow-y: auto; overflow-x: hidden;">
                                        <MudDataGrid T="MachineSelectionModel"
                                                     Items="@_machineSelectionList"
                                                     MultiSelection="true"
                                                     @bind-SelectedItems="_selectedMachines"
                                                     Dense="true"
                                                     Hover="true"
                                                     Bordered="true"
                                                     FixedHeader="true"
                                                     Virtualize="true"
                                                     Height="100%">
                                            <Columns>
                                                <SelectColumn T="MachineSelectionModel" />
                                                <TemplateColumn Title="Online" CellClass="d-flex justify-center">
                                                    <CellTemplate>
                                                        @if (context.Item.IsOnline)
                                                        {
                                                            <MudIcon Icon="@Icons.Material.Filled.Wifi" Color="MudBlazor.Color.Success" Size="MudBlazor.Size.Small" />
                                                        }
                                                        else
                                                        {
                                                            <MudIcon Icon="@Icons.Material.Filled.WifiOff" Color="MudBlazor.Color.Error" Size="MudBlazor.Size.Small" />
                                                        }
                                                    </CellTemplate>
                                                </TemplateColumn>
                                                <PropertyColumn Property="x => x.Machine.MachineName" Title="Makine Adı" />

                                                @* Hedef No Düzenlenebilir ve Seçimi Atlar *@
                                                <TemplateColumn Title="Hedef No" CellClass="d-flex justify-center align-center">
                                                    <CellTemplate>
                                                        <div class="mud-datagrid-row-select-skip" style="width: 70px;">
                                                            <MudNumericField @bind-Value="context.Item.TargetStartSlot"
                                                                             Min="1" Max="98"
                                                                             Variant="Variant.Text"
                                                                             Margin="Margin.None"
                                                                             HideSpinButtons="true"
                                                                             Class="text-center"
                                                                             Style="padding:0; min-height: 0; font-weight: bold;"
                                                                             @onclick:stopPropagation="true" />
                                                        </div>
                                                    </CellTemplate>
                                                </TemplateColumn>

                                            </Columns>
                                        </MudDataGrid>
                                    </MudPaper>

                                    <div class="mt-3">
                                        @* **Global Toplu Numara Giriş Alanı Geri Getirildi** *@
                                        <MudPaper Elevation="3" Class="pa-3 d-flex align-center gap-3" Style="background-color: #f5f5f5; border-radius: 8px;">
                                            <div class="d-flex flex-column">
                                                <MudText Typo="Typo.caption" Style="font-weight:bold;">Hedef Başlangıç No:</MudText>
                                                <MudNumericField @bind-Value="_globalTargetSlot"
                                                                 Min="1" Max="98"
                                                                 Variant="Variant.Outlined"
                                                                 Margin="Margin.Dense"
                                                                 Style="width: 100px; background-color: white;"
                                                                 TextChanged="OnGlobalSlotChanged" />
                                            </div>
                                            <MudDivider Vertical="true" FlexItem="true" Class="mx-2" />
                                            <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Success" Size="MudBlazor.Size.Large" StartIcon="@Icons.Material.Filled.CloudUpload" OnClick="StartTransferProcess" FullWidth="true" Class="flex-grow-1" Disabled="@(_selectedRecipes.Count == 0 || _selectedMachines.Count == 0 || isBusy)">
                                                GÖNDERİMİ BAŞLAT
                                            </MudButton>
                                        </MudPaper>
                                    </div>

                                </MudItem>
                            </MudGrid>
                        </MudTabPanel>

                        <MudTabPanel Text="Reçete Al (Makine -> PC)" Icon="@Icons.Material.Filled.CloudDownload" Style="height: 100%;">
                            <MudGrid Spacing="3">

                                <MudItem xs="12" md="4">
                                    <div class="mb-3">
                                        <MudText Typo="Typo.subtitle2" Class="mb-1"><b>Kaynak Seçimi</b></MudText>
                                        <MudPaper Class="pa-3" Elevation="3" Style="background-color:#fcfcfc;" Hover="true"
                                                  Dense="true">
                                            <MudSelect T="Machine" Label="Makine Seçiniz" Value="_downloadSourceMachine" ValueChanged="OnDownloadSourceChanged" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                                                @if (AllMachines != null)
                                                {
                                                    @foreach (var m in AllMachines.Where(x => !string.IsNullOrEmpty(x.FtpUsername)))
                                                    {
                                                        <MudSelectItem Value="@m">@m.MachineName</MudSelectItem>
                                                    }
                                                }
                                            </MudSelect>
                                            @if (_isLoadingHmi)
                                            {
                                                <div class="d-flex align-center mt-3 gap-2">
                                                    <MudProgressCircular Size="MudBlazor.Size.Small" Indeterminate="true" Color="MudBlazor.Color.Primary" />
                                                    <MudText Typo="Typo.caption">Hafıza okunuyor...</MudText>
                                                </div>
                                            }
                                        </MudPaper>
                                    </div>
                                </MudItem>

                                <MudItem xs="12" md="8">
                                    <div>
                                        <MudText Typo="Typo.subtitle2" Class="mb-2"><b>HMI Reçeteleri (PLC)</b></MudText>
                                    </div>

                                    <MudPaper Elevation="0" Outlined="true" Class="d-flex flex-column border-2 mud-border-warning"
                                              Style="height: 55vh; overflow-y: auto; overflow-x: hidden;">
                                        <MudDataGrid T="HmiRecipeModel"
                                                     Items="@_hmiRecipes"
                                                     MultiSelection="true"
                                                     @bind-SelectedItems="_selectedHmiRecipes"
                                                     Dense="true"
                                                     Hover="true"
                                                     Bordered="true"
                                                     FixedHeader="true"
                                                     Virtualize="true"
                                                     Height="100%">
                                            <Columns>
                                                <SelectColumn T="HmiRecipeModel" />
                                                <PropertyColumn Property="x => x.SlotNumber" Title="No" CellStyle="width: 70px; font-weight:bold;" />
                                                <PropertyColumn Property="x => x.RecipeName" Title="Reçete Adı" />
                                            </Columns>
                                        </MudDataGrid>
                                    </MudPaper>

                                    <div class="mt-3">
                                        <MudPaper Elevation="3" Class="pa-3 d-flex justify-end align-center" Style="background-color: #fff3e0; border-radius: 8px;">
                                            <MudText Typo="Typo.body2" Class="mr-4">Seçilen: <b>@_selectedHmiRecipes.Count</b> adet</MudText>
                                            <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Warning" Size="MudBlazor.Size.Large" StartIcon="@Icons.Material.Filled.CloudDownload"
                                                       OnClick="StartDownloadProcess"
                                                       Disabled="@(_selectedHmiRecipes.Count == 0 || _downloadSourceMachine == null || isBusy)">
                                                DOWNLOAD
                                            </MudButton>
                                        </MudPaper>
                                    </div>
                                </MudItem>
                            </MudGrid>
                        </MudTabPanel>

                    </MudTabs>
                </MudItem>

                <MudItem xs="12" md="4" Class="d-flex flex-column" Style="height: 100%;">

                    <div class="mb-2 flex-shrink-0">
                        <MudText Typo="Typo.h6"><MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" /> İşlem Kuyruğu</MudText>
                    </div>

                    <MudPaper Elevation="4" Class="d-flex flex-column"
                              Style="height: 70vh; background-color: #f8f9fa; overflow: hidden;">

                        <div class="flex-grow-1 overflow-y-auto pa-2">
                            @if (_activeJobs.Any())
                            {
                                <MudList T="string" Dense="true" DisablePadding="true">
                                    @foreach (var job in _activeJobs)
                                    {
                                        if (job != null)
                                        {
                                            <MudPaper Elevation="1" Class="mb-2 pa-2">
                                                <div class="d-flex justify-space-between">
                                                    <MudText Typo="Typo.body2" Style="font-weight:bold">
                                                        @if (job.OperationType == TransferType.Send)
                                                        {
                                                            <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Success" Class="mr-1" />
                                                        }
                                                        else
                                                        {
                                                            <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Warning" Class="mr-1" />
                                                        }
                                                        @job.RecipeName
                                                    </MudText>
                                                    <MudText Typo="Typo.caption">@job.MachineName</MudText>
                                                </div>
                                                <MudProgressLinear Color="@GetJobColor(job)" Value="@job.Progress" Class="my-1" Striped="true" />
                                                <div class="d-flex justify-space-between">
                                                    <MudText Typo="Typo.caption" Color="@GetJobColor(job)">@job.Status</MudText>
                                                    @if (!string.IsNullOrEmpty(job.ErrorMessage))
                                                    {
                                                        <MudText Typo="Typo.caption" Color="MudBlazor.Color.Error">@job.ErrorMessage</MudText>
                                                    }
                                                </div>
                                            </MudPaper>
                                        }
                                    }
                                </MudList>
                            }
                            else
                            {
                                <div class="d-flex flex-column align-center justify-center" style="height:100%; opacity:0.5">
                                    <MudIcon Icon="@Icons.Material.Filled.Inbox" Size="MudBlazor.Size.Large" />
                                    <MudText>Kuyruk boş</MudText>
                                </div>
                            }
                        </div>
                    </MudPaper>

                    @if (isBusy)
                    {
                        <div class="pt-2 flex-shrink-0">
                            <MudPaper Class="pa-2" Elevation="0" Style="background-color:transparent">
                                <MudProgressLinear Color="MudBlazor.Color.Info" Indeterminate="true" />
                                <MudText Align="MudBlazor.Align.Center" Typo="Typo.caption">İşlemler sürüyor...</MudText>
                            </MudPaper>
                        </div>
                    }
                </MudItem>

            </MudGrid>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="() => MudDialog.Cancel()" Color="MudBlazor.Color.Default">Kapat</MudButton>
    </DialogActions>
</MudDialog>

@code {
    // Değişkenler ve Metotlar (Tamamen Aynı)
    // ...
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }

    [Parameter] public List<ScadaRecipe>? LocalRecipes { get; set; }
    [Parameter] public List<Machine>? AllMachines { get; set; }
    [Parameter] public string InitialTargetType { get; set; } = "";

    public class MachineSelectionModel
    {
        public Machine Machine { get; set; }
        public bool IsOnline { get; set; } = false;
        public int TargetStartSlot { get; set; } = 1;
    }

    public class HmiRecipeModel
    {
        public int SlotNumber { get; set; }
        public string RecipeName { get; set; } = "";
    }

    private List<string> _availableTypes = new();
    private string _filterType = "";
    private List<ScadaRecipe> _filteredRecipes = new();
    private HashSet<ScadaRecipe> _selectedRecipes = new();
    private List<MachineSelectionModel> _machineSelectionList = new();
    private HashSet<MachineSelectionModel> _selectedMachines = new();
    private int _globalTargetSlot = 1;

    private Machine? _downloadSourceMachine;
    private List<HmiRecipeModel> _hmiRecipes = new();
    private HashSet<HmiRecipeModel> _selectedHmiRecipes = new();
    private bool _isLoadingHmi = false;

    private List<TransferJob> _activeJobs = new();
    private bool isBusy = false;

    protected override void OnInitialized()
    {
        if (LocalRecipes != null)
            _availableTypes = LocalRecipes.Select(r => r.TargetMachineType).Distinct().ToList();
        if (!string.IsNullOrEmpty(InitialTargetType) && _availableTypes.Contains(InitialTargetType))
            _filterType = InitialTargetType;
        else if (_availableTypes.Any())
            _filterType = _availableTypes.First();

        FilterRecipes();
        LoadMachinesForType();
        ScadaDataService.OnFtpProgressReceived += OnFtpProgress;
        UpdateMachineStatuses();
    }

    private void OnFilterTypeChanged(string value)
    {
        _filterType = value;
        FilterRecipes();
        LoadMachinesForType();
        InvokeAsync(StateHasChanged);
    }

    private void FilterRecipes()
    {
        if (LocalRecipes == null) return;
        _filteredRecipes = LocalRecipes.Where(r => r.TargetMachineType == _filterType).ToList();
        _selectedRecipes.Clear();
    }

    private void LoadMachinesForType()
    {
        if (AllMachines == null) return;
        _machineSelectionList = AllMachines
            .Where(m => !string.IsNullOrEmpty(m.FtpUsername) && m.MachineType != "Kurutma Makinesi" && GetMachineFilterType(m) == _filterType)
            .Select(m => new MachineSelectionModel { Machine = m, TargetStartSlot = 1 })
            .ToList();
        _selectedMachines.Clear();
        UpdateMachineStatuses();
    }

    private void UpdateMachineStatuses()
    {
        foreach (var item in _machineSelectionList)
        {
            if (ScadaDataService.MachineData.TryGetValue(item.Machine.Id, out var status))
                item.IsOnline = status.ConnectionState == ConnectionStatus.Connected;
        }
    }

    private void OnGlobalSlotChanged()
    {
        foreach (var m in _machineSelectionList) m.TargetStartSlot = _globalTargetSlot;
    }

    private async Task OnDownloadSourceChanged(Machine machine)
    {
        _downloadSourceMachine = machine;
        _hmiRecipes.Clear();
        _selectedHmiRecipes.Clear();

        if (machine == null) return;

        _isLoadingHmi = true;
        InvokeAsync(StateHasChanged);
        try
        {
            var recipesDict = await ScadaDataService.GetHmiRecipeNamesAsync(machine.Id);
            if (recipesDict != null && recipesDict.Any())
            {
                _hmiRecipes = recipesDict.Select(kvp => new HmiRecipeModel
                {
                    SlotNumber = kvp.Key,
                    RecipeName = kvp.Value
                }).ToList();
            }
            else
            {
                Snackbar.Add("PLC'de kayıtlı reçete ismi bulunamadı.", Severity.Info);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Reçete listesi alınamadı: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoadingHmi = false;
        }
    }

    private async Task StartDownloadProcess()
    {
        if (_downloadSourceMachine == null || !_selectedHmiRecipes.Any()) return;

        isBusy = true;
        StateHasChanged();
        try
        {
            var fileNamesToRequest = new List<string>();
            foreach (var hmiRecipe in _selectedHmiRecipes)
            {
                string fileName = $"XPR{hmiRecipe.SlotNumber:D5}.csv";
                fileNamesToRequest.Add(fileName);
            }

            await ScadaDataService.QueueReceiveJobsAsync(fileNamesToRequest, _downloadSourceMachine.Id);
            Snackbar.Add($"{fileNamesToRequest.Count} reçete indirme kuyruğuna eklendi.", Severity.Success);
            _selectedHmiRecipes.Clear();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
        }
        finally
        {
            isBusy = false;
            StateHasChanged();
        }
    }

    private async Task StartTransferProcess()
    {
        if (!_selectedRecipes.Any() || !_selectedMachines.Any()) return;
        var offlineMachines = _selectedMachines.Where(m => !m.IsOnline).ToList();
        if (offlineMachines.Any())
        {
            var confirm = await JSRuntime.InvokeAsync<bool>("confirm", $"{offlineMachines.Count} makine OFFLINE. Yine de eklensin mi?");
            if (!confirm) return;
        }

        isBusy = true;
        StateHasChanged();
        try
        {
            foreach (var machineItem in _selectedMachines)
            {
                var recipeIds = _selectedRecipes.Select(r => r.Id).ToList();
                var machineIds = new List<int> { machineItem.Machine.Id };
                int startSlot = machineItem.TargetStartSlot;
                if (startSlot + recipeIds.Count - 1 > 98)
                {
                    Snackbar.Add($"{machineItem.Machine.MachineName} limit aşıldı!", Severity.Warning);
                    continue;
                }
                await ScadaDataService.QueueSequentiallyNamedSendJobsAsync(recipeIds, machineIds, startSlot);
                Snackbar.Add($"{machineItem.Machine.MachineName}: Kuyruğa alındı.", Severity.Success);
            }
        }
        catch (Exception ex) { Snackbar.Add($"Hata: {ex.Message}", Severity.Error); }
        finally { isBusy = false; StateHasChanged(); }
    }

    private void OnFtpProgress(TransferJob job)
    {
        if (job == null) return;
        var existing = _activeJobs.FirstOrDefault(j => j != null && j.Id == job.Id);
        if (existing != null)
        {
            existing.Progress = job.Progress;
            existing.Status = job.Status;
            existing.ErrorMessage = job.ErrorMessage;
        }
        else
        {
            _activeJobs.Insert(0, job);
        }
        InvokeAsync(StateHasChanged);
    }

    private MudBlazor.Color GetJobColor(TransferJob job)
    {
        if (job == null) return MudBlazor.Color.Default;
        return job.Status switch
        {
            TransferStatus.Successful => MudBlazor.Color.Success,
            TransferStatus.Failed => MudBlazor.Color.Error,
            TransferStatus.Transferring => MudBlazor.Color.Info,
            _ => MudBlazor.Color.Default
        };
    }

    private string GetMachineFilterType(Machine machine)
    {
        return string.IsNullOrEmpty(machine.MachineSubType) ? machine.MachineType : machine.MachineSubType;
    }

    public void Dispose()
    {
        ScadaDataService.OnFtpProgressReceived -= OnFtpProgress;
    }
}