@using TekstilScada.Models
@using TekstilScada.Services
@using TekstilScada.WebApp.Services
@using System.Collections.Concurrent
@using MudBlazor  @* <-- BU SATIR ÇOK ÖNEMLİ (CS0246 Çözümü) *@

@inject ScadaDataService ScadaDataService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime



<MudDialog DisableSidePadding="true" MaxWidth="MaxWidth.False" Style="width:95vw; height:90vh;">
    <DialogContent>
        <MudContainer Style="height: 100%; overflow: hidden;" Class="pa-2">
            <MudGrid Style="height: 100%;">

                <MudItem xs="12" md="3" Class="d-flex flex-column" Style="height: 100%;">
                    <MudPaper Elevation="3" Class="pa-3 flex-grow-1 d-flex flex-column">
                        <MudText Typo="Typo.h6" Color="MudBlazor.Color.Primary" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.Description" Class="mr-2" /> Yerel Reçeteler
                        </MudText>
                        <MudDivider Class="mb-3" />

                        <MudSelect T="string" Label="Reçete Tipi" @bind-Value="_filterType" SelectedValuesChanged="OnFilterTypeChanged" Dense="true" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-2">
                            @foreach (var type in _availableTypes)
                            {
                                <MudSelectItem Value="@type">@type</MudSelectItem>
                            }
                        </MudSelect>

                        <MudDataGrid T="ScadaRecipe"
                                     Items="@_filteredRecipes"
                                     MultiSelection="true"
                                     @bind-SelectedItems="_selectedRecipes"
                                     Dense="true" Hover="true" Bordered="true"
                                     Class="flex-grow-1 overflow-auto" FixedHeader="true" Height="100%">
                            <Columns>
                                <SelectColumn T="ScadaRecipe" />
                                <PropertyColumn Property="x => x.RecipeName" Title="Reçete Adı" />
                            </Columns>
                        </MudDataGrid>
                        <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">@(_selectedRecipes.Count) reçete seçildi.</MudAlert>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="5" Class="d-flex flex-column" Style="height: 100%;">
                    <MudPaper Elevation="3" Class="pa-3 flex-grow-1 d-flex flex-column">
                        <MudText Typo="Typo.h6" Color="MudBlazor.Color.Secondary" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.PrecisionManufacturing" Class="mr-2" /> Hedef Makineler
                        </MudText>
                        <MudDivider Class="mb-3" />

                        <MudDataGrid T="MachineSelectionModel"
                                     Items="@_machineSelectionList"
                                     MultiSelection="true"
                                     @bind-SelectedItems="_selectedMachines"
                                     Dense="true" Hover="true" Bordered="true"
                                     Class="flex-grow-1 overflow-auto" FixedHeader="true" Height="100%">
                            <Columns>
                                <SelectColumn T="MachineSelectionModel" />
                                <TemplateColumn Title="Durum" CellClass="d-flex justify-center">
                                    <CellTemplate>
                                        @if (context.Item.IsOnline)
                                        {
                                            <MudIcon Icon="@Icons.Material.Filled.Wifi" Color="MudBlazor.Color.Success" Size="MudBlazor.Size.Small" />
                                        }
                                        else
                                        {

                                            <MudIcon Icon="@Icons.Material.Filled.WifiOff" Color="MudBlazor.Color.Error" Size="MudBlazor.Size.Small" />
                                        }
                                    </CellTemplate>
                                </TemplateColumn>
                                <PropertyColumn Property="x => x.Machine.MachineName" Title="Makine Adı" />
                                <TemplateColumn Title="Hedef No">
                                    <CellTemplate>
                                        <MudNumericField @bind-Value="context.Item.TargetStartSlot" Min="1" Max="98" Margin="Margin.Dense" Variant="Variant.Text" HideSpinButtons="true" Style="width: 50px;" />
                                    </CellTemplate>
                                </TemplateColumn>
                            </Columns>
                        </MudDataGrid>

                        <div class="d-flex gap-2 mt-3 align-center">
                            <MudText Typo="Typo.caption" Align="MudBlazor.Align.Center">Toplu Hedef No:</MudText>
                            <MudNumericField @bind-Value="_globalTargetSlot" Min="1" Max="98" Variant="Variant.Outlined" Margin="Margin.Dense" Style="width: 80px;" TextChanged="OnGlobalSlotChanged" />
                            <MudSpacer />
                            <MudButton Variant="Variant.Filled" Color="MudBlazor.Color.Success" StartIcon="@Icons.Material.Filled.CloudUpload" OnClick="StartTransferProcess" Disabled="@(_selectedRecipes.Count == 0 || _selectedMachines.Count == 0 || isBusy)">
                                GÖNDERİMİ BAŞLAT
                            </MudButton>
                        </div>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="4" Class="d-flex flex-column" Style="height: 100%;">
                    <MudPaper Elevation="4" Class="pa-3 flex-grow-1 d-flex flex-column" Style="background-color: #f8f9fa;">
                        <MudText Typo="Typo.h6" Class="mb-2"><MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" /> Transfer Kuyruğu</MudText>
                        <MudDivider Class="mb-3" />
                        @if (_activeJobs.Any())
                        {
                            <div class="flex-grow-1 overflow-auto" style="min-height: 0;">
                            <MudList T="string" Dense="true" Class="flex-grow-1 overflow-auto">
                                @foreach (var job in _activeJobs)
                                {
                                    <MudListItem T="string">
                                        <div class="d-flex flex-column w-100">
                                            <div class="d-flex justify-space-between">
                                                <MudText Typo="Typo.body2"><b>@job.RecipeName</b> <span class="mud-text-secondary">-></span> <b>@job.MachineName</b></MudText>
                                            </div>
                                            <MudProgressLinear Color="@GetJobColor(job)" Value="@job.Progress" Class="my-1" Striped="true" />
                                            <div class="d-flex justify-space-between">
                                                <MudText Typo="Typo.caption" Color="@GetJobColor(job)">@job.Status</MudText>
                                                <MudText Typo="Typo.caption">@job.Progress%</MudText>
                                            </div>
                                            @if (!string.IsNullOrEmpty(job.ErrorMessage))
                                            {
                                                <MudText Typo="Typo.caption" Color="MudBlazor.Color.Error">@job.ErrorMessage</MudText>
                                            }
                                        </div>
                                    </MudListItem>
                                    <MudDivider />
                                }
                            </MudList>
                            </div>
                        }
                        else
                        {

                            <div class="d-flex flex-column align-center justify-center flex-grow-1" style="opacity:0.5"><MudText>Kuyruk boş</MudText></div>
                        }

                        @if (isBusy)
                        {
                            <MudProgressLinear Color="MudBlazor.Color.Info" Indeterminate="true" Class="mt-2" />
                            <MudText Align="MudBlazor.Align.Center" Typo="Typo.caption">İşlemler sürüyor...</MudText>
                        }
                    </MudPaper>
                </MudItem>

            </MudGrid>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="() => MudDialog.Cancel()" Color="MudBlazor.Color.Default">Kapat</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }

    [Parameter] public List<ScadaRecipe>? LocalRecipes { get; set; }
    [Parameter] public List<Machine>? AllMachines { get; set; }
    [Parameter] public string InitialTargetType { get; set; } = "";

    // Modeller
    public class MachineSelectionModel
    {
        public Machine Machine { get; set; }
        public bool IsOnline { get; set; } = false;
        public int TargetStartSlot { get; set; } = 1;
    }

    // Değişkenler
    private List<string> _availableTypes = new();
    private string _filterType = "";

    private List<ScadaRecipe> _filteredRecipes = new();
    private HashSet<ScadaRecipe> _selectedRecipes = new();

    private List<MachineSelectionModel> _machineSelectionList = new();
    private HashSet<MachineSelectionModel> _selectedMachines = new();

    private int _globalTargetSlot = 1;
    private List<TransferJob> _activeJobs = new();
    private bool isBusy = false;

    protected override void OnInitialized()
    {
        if (LocalRecipes != null)
            _availableTypes = LocalRecipes.Select(r => r.TargetMachineType).Distinct().ToList();

        if (!string.IsNullOrEmpty(InitialTargetType) && _availableTypes.Contains(InitialTargetType))
            _filterType = InitialTargetType;
        else if (_availableTypes.Any())
            _filterType = _availableTypes.First();

        FilterRecipes();
        LoadMachinesForType();

        ScadaDataService.OnFtpProgressReceived += OnFtpProgress;
        UpdateMachineStatuses();
    }

    // DÜZELTME: Metot imzası IEnumerable<string> olarak güncellendi (CS1503 Çözümü)
    private void OnFilterTypeChanged(IEnumerable<string> values)
    {
        _filterType = values.FirstOrDefault(); // İlk seçilen değeri al
        FilterRecipes();
        LoadMachinesForType();
    }

    private void FilterRecipes()
    {
        if (LocalRecipes == null) return;
        _filteredRecipes = LocalRecipes.Where(r => r.TargetMachineType == _filterType).ToList();
        _selectedRecipes.Clear();
    }

    private void LoadMachinesForType()
    {
        if (AllMachines == null) return;
        _machineSelectionList = AllMachines
            .Where(m => !string.IsNullOrEmpty(m.FtpUsername) && m.MachineType != "Kurutma Makinesi" && GetMachineFilterType(m) == _filterType)
            .Select(m => new MachineSelectionModel { Machine = m, TargetStartSlot = 1 })
            .ToList();
        _selectedMachines.Clear();
        UpdateMachineStatuses();
    }

    private void UpdateMachineStatuses()
    {
        foreach (var item in _machineSelectionList)
        {
            if (ScadaDataService.MachineData.TryGetValue(item.Machine.Id, out var status))
                item.IsOnline = status.ConnectionState == ConnectionStatus.Connected;
        }
    }

    private void OnGlobalSlotChanged()
    {
        foreach (var m in _machineSelectionList) m.TargetStartSlot = _globalTargetSlot;
    }

    private async Task StartTransferProcess()
    {
        if (!_selectedRecipes.Any() || !_selectedMachines.Any()) return;

        var offlineMachines = _selectedMachines.Where(m => !m.IsOnline).ToList();
        if (offlineMachines.Any())
        {
            var confirm = await JSRuntime.InvokeAsync<bool>("confirm", $"{offlineMachines.Count} makine OFFLINE. Yine de eklensin mi?");
            if (!confirm) return;
        }

        isBusy = true;
        StateHasChanged();
        try
        {
            foreach (var machineItem in _selectedMachines)
            {
                var recipeIds = _selectedRecipes.Select(r => r.Id).ToList();
                var machineIds = new List<int> { machineItem.Machine.Id };
                int startSlot = machineItem.TargetStartSlot;

                if (startSlot + recipeIds.Count - 1 > 98)
                {
                    Snackbar.Add($"{machineItem.Machine.MachineName} limit aşıldı!", Severity.Warning);
                    continue;
                }
                await ScadaDataService.QueueSequentiallyNamedSendJobsAsync(recipeIds, machineIds, startSlot);
                Snackbar.Add($"{machineItem.Machine.MachineName}: Kuyruğa alındı.", Severity.Success);
            }
        }
        catch (Exception ex) { Snackbar.Add($"Hata: {ex.Message}", Severity.Error); }
        finally { isBusy = false; StateHasChanged(); }
    }

    private void OnFtpProgress(TransferJob job)
    {
        // 1. KORUMA: Gelen job null ise hiçbir şey yapma.
        if (job == null) return;

        // 2. KORUMA: Liste içinde null kayıt varsa (önceden eklenmişse) hatayı önlemek için 'j != null' kontrolü ekle.
        var existing = _activeJobs.FirstOrDefault(j => j != null && j.Id == job.Id);

        if (existing != null)
        {
            existing.Progress = job.Progress;
            existing.Status = job.Status;
            existing.ErrorMessage = job.ErrorMessage;
        }
        else
        {
            // Listeye eklerken de null olmadığından eminiz (yukarıdaki if sayesinde)
            _activeJobs.Insert(0, job);
        }
        InvokeAsync(StateHasChanged);
    }

    private MudBlazor.Color GetJobColor(TransferJob job)
    {
        return job.Status switch
        {
            TransferStatus.Successful => MudBlazor.Color.Success,
            TransferStatus.Failed => MudBlazor.Color.Error,
            TransferStatus.Transferring => MudBlazor.Color.Info,
            _ => MudBlazor.Color.Default
        };
    }

    private string GetMachineFilterType(Machine machine)
    {
        return string.IsNullOrEmpty(machine.MachineSubType) ? machine.MachineType : machine.MachineSubType;
    }

    public void Dispose()
    {
        ScadaDataService.OnFtpProgressReceived -= OnFtpProgress;
    }
}