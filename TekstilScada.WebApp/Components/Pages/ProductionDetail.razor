@page "/reports/production-detail/{MachineId:int}/{BatchId}"
@rendermode InteractiveServer
@using TekstilScada.Repositories
@using TekstilScada.Core.Models
@using TekstilScada.Models
@using TekstilScada.WebApp.Services
@using TekstilScada.Core.Localization
@using Microsoft.Extensions.Localization
@inject ScadaDataService ScadaDataService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject IStringLocalizer<SharedResource> Loc

<PageTitle>@Loc["UretimDetayiBaslik"] - @BatchId</PageTitle>

@if (isLoading)
{
    <div class="alert alert-info text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">@Loc["Yukleniyor"]</span>
        </div>
        @statusMessage
    </div>
}
else if (detailData == null)
{
    <div class="alert alert-danger text-center">@Loc["UretimDetayiBulunamadi"]</div>
}
else
{
    <div class="production-detail-container">
        <h1 class="mb-4">@Loc["UretimDetayRaporuBaslik"] - @detailData.Header.BatchId</h1>

        <div class="card mb-4">
            <div class="card-header bg-light fw-bold">@Loc["GenelBilgiler"]</div>
            <div class="card-body">
                <div class="row">
                    @* Makine Adı, Reçete Adı vb. için önceki resource'ları veya yeni eklediklerimizi kullanıyoruz *@
                    <DetailItem Label="@Loc["MakineAdi"]" Value="@detailData.Header.MachineName" />
                    <DetailItem Label="@Loc["ReceteAdiLabel"]" Value="@detailData.Header.RecipeName" />
                    <DetailItem Label="@Loc["OperatorLabel"]" Value="@detailData.Header.OperatorName" />
                    <DetailItem Label="@Loc["MusteriNoLabel"]" Value="@detailData.Header.MusteriNo" />
                    <DetailItem Label="@Loc["SiparisNoLabel"]" Value="@detailData.Header.SiparisNo" />
                </div>
                <div class="row mt-3">
                    <DetailItem Label="@Loc["BaslangicZamani"]" Value="@detailData.Header.StartTime.ToString("dd.MM.yyyy HH:mm:ss")" />
                    <DetailItem Label="@Loc["BitisZamani"]" Value="@detailData.Header.EndTime.ToString("dd.MM.yyyy HH:mm:ss")" />
                    <DetailItem Label="@Loc["ToplamSure"]" Value="@detailData.Header.CycleTime" />
                </div>
                <button class="btn btn-primary mt-3" @onclick="ExportToExcel">
                    <i class="oi oi-data-transfer-download"></i> @Loc["ExceleAktar"]
                </button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card h-100">
                    <div class="card-header fw-bold">@Loc["ProsesZamanCizgisiBaslik"]</div>
                    <div class="card-body">
                        <div id="trendChart" style="height: 400px;">
                            <p class="text-center text-muted">@Loc["ZamanCizgisiPlaceholder"]</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header fw-bold">@Loc["SureDagilimiBaslik"]</div>
                    <div class="card-body d-flex flex-column justify-content-center">
                        <div id="pie-chart" style="height: 250px;">
                            <p class="text-center text-muted">@Loc["PastaGrafikPlaceholder"]</p>
                        </div>
                        <div class="mt-3">
                            @foreach (var segment in pieChartSegments)
                            {
                                <div class="d-flex justify-content-between mb-1" style="border-left: 5px solid @segment.Color">
                                    <span class="fw-bold">@segment.Label</span>
                                    <span>@segment.Duration</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header fw-bold">@Loc["AdimDetaylariBaslik"]</div>
                    <div class="card-body table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>@Loc["AdimNo"]</th>
                                    <th>@Loc["AciklamaSutun"]</th>
                                    <th>@Loc["TeorikSure"]</th>
                                    <th>@Loc["GerceklesenSure"]</th>
                                    <th>@Loc["Sicaklik"]</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var step in detailData.Steps)
                                {
                                    <tr style="@GetStepDurationStyle(step)">
                                        <td>@step.StepNumber</td>
                                        <td>@step.StepDescription</td>
                                        <td>@TimeSpan.FromSeconds(step.TheoreticalDurationSeconds).ToString(@"hh\:mm\:ss")</td>
                                        <td>@step.WorkingTime</td>
                                        <td>@step.Temperature.ToString("F1") °C</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header fw-bold">@Loc["AlarmGecmisiBaslik"]</div>
                    <div class="card-body table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>@Loc["Tarih"]</th>
                                    <th>@Loc["Tip"]</th>
                                    <th>@Loc["AciklamaSutun"]</th>
                                    <th>@Loc["Sure"]</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var alarm in detailData.Alarms)
                                {
                                    <tr>
                                        <td>@alarm.AlarmTime.ToString("HH:mm:ss")</td>
                                        <td>@alarm.AlarmType</td>
                                        <td>@alarm.AlarmDescription</td>
                                        <td>@alarm.Duration.ToString(@"hh\:mm\:ss")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int MachineId { get; set; }
    [Parameter] public string BatchId { get; set; } = string.Empty;

    private ProductionDetailDto? detailData;
    private bool isLoading = true;
    private string statusMessage = ""; // Initialize in OnInitialized based on Localization
    private List<PieChartSegment> pieChartSegments = new();
    private List<TrendDataPoint>? actualDataPoints;
    private bool _chartsDrawn = false;
    private List<TrendProcessDataPoint>? trendDataPoints;
    private bool shouldRenderChart = false;
    private bool shouldRenderChart2 = false;

    private class PieChartSegment
    {
        public string Label { get; set; } = string.Empty;
        public string Color { get; set; } = string.Empty;
        public TimeSpan DurationTimeSpan { get; set; }
        public string Duration => DurationTimeSpan.ToString(@"hh\:mm\:ss");
        public double Value { get; set; }
    }
    private class TrendProcessDataPoint
    {
        public int MachineId { get; set; }
        public DateTime Timestamp { get; set; }
        public decimal Temperature { get; set; }
        public decimal WaterLevel { get; set; }
        public int Rpm { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        // İlk mesajı burada set ediyoruz
        statusMessage = Loc["UretimDetaylariYukleniyor"];

        if (MachineId == 0 || string.IsNullOrEmpty(BatchId))
        {
            statusMessage = Loc["HataMakineBatchEksik"];
            isLoading = false;
            return;
        }

        try
        {
            detailData = await ScadaDataService.GetProductionDetailAsync(MachineId, BatchId);
            await GenerateTrendReport();
            if (detailData != null)
            {
                CalculatePieChart(detailData.Header);
            }
            else
            {
                statusMessage = Loc["DetaylarBos"];
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"{Loc["VeriYuklemeHatasiMesaj"]}: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (shouldRenderChart2 && detailData != null && !_chartsDrawn)
        {
            await DrawPieChartAsync();

            _chartsDrawn = true;
            shouldRenderChart2 = false;
        }
        if (shouldRenderChart && trendDataPoints != null && trendDataPoints.Any())
        {
            shouldRenderChart = false;
            await CallPlotlyJS();
        }
    }
    private async Task DrawPieChartAsync()
    {
        if (pieChartSegments.Any())
        {
            var chartData = pieChartSegments.Select(s => new
            {
                label = s.Label,
                value = s.DurationTimeSpan.TotalSeconds,
                color = s.Color
            }).ToList();

            await JSRuntime.InvokeVoidAsync("drawPieChart", "pie-chart", chartData);
        }
    }

    private async Task CallPlotlyJS()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("plotTrendChart",
                "trendChart",
                trendDataPoints,
                "Temperature");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Plotly JS çağrısı başarısız oldu:", ex.Message);
        }
    }
    private async Task GenerateTrendReport()
    {
        isLoading = true;
        actualDataPoints = null;
        await InvokeAsync(StateHasChanged);

        try
        {
            var effectiveFilters = new ReportFilters
            {
                StartTime = detailData.Header.StartTime,
                EndTime = detailData.Header.EndTime,
                MachineId = MachineId,
            };

            await JSRuntime.InvokeVoidAsync("console.log", "API'ye gönderilen Trend filtreleri:", effectiveFilters);

            var rawData = await ScadaDataService.GetTrendDataAsync(effectiveFilters);

            if (rawData != null)
            {
                var jsonString = System.Text.Json.JsonSerializer.Serialize(rawData);
                var trendData = System.Text.Json.JsonSerializer.Deserialize<List<TrendProcessDataPoint>>(jsonString, new System.Text.Json.JsonSerializerOptions(System.Text.Json.JsonSerializerDefaults.Web));
                trendDataPoints = trendData;

                if (trendDataPoints.Any())
                {
                    shouldRenderChart = true;
                }
                else
                {
                    shouldRenderChart = false;
                }
            }
        }
        catch (Exception ex)
        {
            shouldRenderChart = false;
            await JSRuntime.InvokeVoidAsync("console.error", "Trend Raporu oluşturulurken hata oluştu:", ex.ToString());
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void CalculatePieChart(ProductionReportItem reportItem)
    {
        pieChartSegments.Clear();

        double totalMachineAlarmSeconds = reportItem.MachineAlarmDurationSeconds;
        double totalOperatorPauseSeconds = reportItem.OperatorPauseDurationSeconds;
        double totalBatchSeconds = (reportItem.EndTime - reportItem.StartTime).TotalSeconds;

        double activeWorkingSeconds = totalBatchSeconds - totalMachineAlarmSeconds - totalOperatorPauseSeconds;
        if (activeWorkingSeconds < 0) activeWorkingSeconds = 0;

        if (activeWorkingSeconds > 0)
        {
            pieChartSegments.Add(new PieChartSegment
            {
                Label = Loc["AktifCalisma"],
                Color = "DodgerBlue",
                DurationTimeSpan = TimeSpan.FromSeconds(activeWorkingSeconds),
                Value = activeWorkingSeconds
            });
        }
        if (totalMachineAlarmSeconds > 0)
        {
            pieChartSegments.Add(new PieChartSegment
            {
                Label = Loc["MakineAlarm"],
                Color = "Crimson",
                DurationTimeSpan = TimeSpan.FromSeconds(totalMachineAlarmSeconds),
                Value = totalMachineAlarmSeconds
            });
        }
        if (totalOperatorPauseSeconds > 0)
        {
            pieChartSegments.Add(new PieChartSegment
            {
                Label = Loc["OperatorDuraklama"],
                Color = "Orange",
                DurationTimeSpan = TimeSpan.FromSeconds(totalOperatorPauseSeconds),
                Value = totalOperatorPauseSeconds
            });
        }

        if (!pieChartSegments.Any())
        {
            pieChartSegments.Add(new PieChartSegment { Label = Loc["VeriYok"], Color = "Gray", DurationTimeSpan = TimeSpan.Zero });
        }
        if (pieChartSegments.Any())
        {
            shouldRenderChart2 = true;
        }
        else
        {
            shouldRenderChart2 = false;
        }
    }

    private string GetStepDurationStyle(ProductionStepDetailDto step)
    {
        if (TimeSpan.TryParse(step.WorkingTime, out TimeSpan workingTime) && step.TheoreticalDurationSeconds > 0)
        {
            TimeSpan theoreticalTime = TimeSpan.FromSeconds(step.TheoreticalDurationSeconds);

            int theoreticalMinutes = (int)theoreticalTime.TotalMinutes;
            int workingMinutes = (int)workingTime.TotalMinutes;

            if (workingMinutes > theoreticalMinutes)
            {
                return "background-color: #f8d7da; color: #721c24; border-left: 5px solid red;";
            }
            else if (workingMinutes < theoreticalMinutes)
            {
                return "background-color: #d4edda; color: #155724; border-left: 5px solid green;";
            }
        }
        return string.Empty;
    }

    private async Task ExportToExcel()
    {
        if (detailData == null) return;

        statusMessage = Loc["ExcelHazirlaniyor"];
        isLoading = true;
        StateHasChanged();

        try
        {
            var excelBytes = await ScadaDataService.ExportProductionDetailFileAsync(MachineId, BatchId);

            if (excelBytes.Any())
            {
                await JSRuntime.InvokeVoidAsync("saveAsFile",
                    $"Uretim_Detayi_{BatchId}_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx",
                    Convert.ToBase64String(excelBytes));

                await JSRuntime.InvokeVoidAsync("alert", Loc["ExcelBasarili"].Value);
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", Loc["ExcelBos"].Value);
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"{Loc["DisaAktarmaHatasi"]}: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}