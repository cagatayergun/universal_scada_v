@page "/reports/production-detail/{MachineId:int}/{BatchId}"

@using TekstilScada.Core.Models
@using TekstilScada.Models
@using TekstilScada.WebApp.Services
@inject ScadaDataService ScadaDataService
@inject IJSRuntime JSRuntime

<PageTitle>Üretim Detayı - @BatchId</PageTitle>

@if (isLoading)
{
    <div class="alert alert-info text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        @statusMessage
    </div>
}
else if (detailData == null)
{
    <div class="alert alert-danger text-center">Üretim detayı bulunamadı.</div>
}
else
{
    <div class="production-detail-container">
        <h1 class="mb-4">Üretim Detay Raporu - @detailData.Header.BatchId</h1>

        <div class="card mb-4">
            <div class="card-header bg-light fw-bold">Genel Bilgiler</div>
            <div class="card-body">
                <div class="row">
                    <DetailItem Label="Makine Adı" Value="@detailData.Header.MachineName" />
                    <DetailItem Label="Reçete Adı" Value="@detailData.Header.RecipeName" />
                    <DetailItem Label="Operatör" Value="@detailData.Header.OperatorName" />
                    <DetailItem Label="Müşteri No" Value="@detailData.Header.MusteriNo" />
                    <DetailItem Label="Sipariş No" Value="@detailData.Header.SiparisNo" />
                </div>
                <div class="row mt-3">
                    <DetailItem Label="Başlangıç" Value="@detailData.Header.StartTime.ToString("dd.MM.yyyy HH:mm:ss")" />
                    <DetailItem Label="Bitiş" Value="@detailData.Header.EndTime.ToString("dd.MM.yyyy HH:mm:ss")" />
                    <DetailItem Label="Toplam Süre" Value="@detailData.Header.CycleTime" />
                </div>
                <button class="btn btn-primary mt-3" @onclick="ExportToExcel">
                    <i class="oi oi-data-transfer-download"></i> Excel'e Aktar
                </button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card h-100">
                    <div class="card-header fw-bold">Proses Zaman Çizgisi (@detailData.Header.MachineName)</div>
                    <div class="card-body">
                        <div id="timeline-chart" style="height: 400px;">
                            <p class="text-center text-muted">Zaman Çizgisi Grafiği burada gösterilecektir.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header fw-bold">Süre Dağılımı (Pasta Grafik)</div>
                    <div class="card-body d-flex flex-column justify-content-center">
                        <div id="pie-chart" style="height: 250px;">
                            <p class="text-center text-muted">Pasta Grafik burada gösterilecektir.</p>
                        </div>
                        <div class="mt-3">
                            @foreach (var segment in pieChartSegments)
                            {
                                <div class="d-flex justify-content-between mb-1" style="border-left: 5px solid @segment.Color">
                                    <span class="fw-bold">@segment.Label</span>
                                    <span>@segment.Duration</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header fw-bold">Adım Detayları</div>
                    <div class="card-body table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Adım No</th>
                                    <th>Açıklama</th>
                                    <th>Teorik Süre</th>
                                    <th>Gerçekleşen Süre</th>
                                    <th>Sıcaklık</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var step in detailData.Steps)
                                {
                                    <tr style="@GetStepDurationStyle(step)">
                                        <td>@step.StepNumber</td>
                                        <td>@step.StepDescription</td>
                                        <td>@TimeSpan.FromSeconds(step.TheoreticalDurationSeconds).ToString(@"hh\:mm\:ss")</td>
                                        <td>@step.WorkingTime</td>
                                        <td>@step.Temperature.ToString("F1") °C</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header fw-bold">Alarm Geçmişi</div>
                    <div class="card-body table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Tip</th>
                                    <th>Açıklama</th>
                                    <th>Süre</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var alarm in detailData.Alarms)
                                {
                                    <tr>
                                        <td>@alarm.AlarmTime.ToString("HH:mm:ss")</td>
                                        <td>@alarm.AlarmType</td>
                                        <td>@alarm.AlarmDescription</td>
                                        <td>@alarm.Duration.ToString(@"hh\:mm\:ss")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int MachineId { get; set; }
    [Parameter] public string BatchId { get; set; } = string.Empty;

    // ScadaDataService'de tanımlanan DTO kullanılır
    private ProductionDetailDto? detailData;
    private bool isLoading = true;
    private string statusMessage = "Üretim detayları yükleniyor...";
    private List<PieChartSegment> pieChartSegments = new();

    // API'dan gelen tüm veriyi tutacak DTO'lar (Tekrar tanımlanmıştır)
   


    private class PieChartSegment
    {
        public string Label { get; set; } = string.Empty;
        public string Color { get; set; } = string.Empty;
        public TimeSpan DurationTimeSpan { get; set; }
        public string Duration => DurationTimeSpan.ToString(@"hh\:mm\:ss");
    }

    protected override async Task OnInitializedAsync()
    {
        if (MachineId == 0 || string.IsNullOrEmpty(BatchId))
        {
            statusMessage = "Hata: Makine veya Batch ID eksik.";
            isLoading = false;
            return;
        }

        try
        {
            // Tek bir API çağrısıyla tüm veriyi al (WinForms'taki birden çok Repository çağrısının karşılığı)
            // Bu metot ScadaDataService'e eklenmelidir.
            detailData = await ScadaDataService.GetProductionDetailAsync(MachineId, BatchId);

            if (detailData != null)
            {
                CalculatePieChart(detailData.Header); // Pasta grafik verisini hesapla
                // Burada Chart.js veya Plotly gibi Blazor uyumlu bir kütüphane için JS interop çağrısı yapılmalıdır.
            }
            else
            {
                statusMessage = "Detaylar boş döndü.";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Veri yüklenirken hata oluştu: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    // WinForms'taki LoadPieChart mantığının karşılığı
    private void CalculatePieChart(ProductionReportItem reportItem)
    {
        pieChartSegments.Clear();

        // 1. Saniye değerlerini al
        double totalMachineAlarmSeconds = reportItem.MachineAlarmDurationSeconds;
        double totalOperatorPauseSeconds = reportItem.OperatorPauseDurationSeconds;
        double totalBatchSeconds = (reportItem.EndTime - reportItem.StartTime).TotalSeconds;

        // 2. Aktif Süreyi Hesapla
        double activeWorkingSeconds = totalBatchSeconds - totalMachineAlarmSeconds - totalOperatorPauseSeconds;
        if (activeWorkingSeconds < 0) activeWorkingSeconds = 0;

        // 3. Segmentleri oluştur
        if (activeWorkingSeconds > 0)
        {
            pieChartSegments.Add(new PieChartSegment
            {
                Label = "Aktif Çalışma",
                Color = "DodgerBlue",
                DurationTimeSpan = TimeSpan.FromSeconds(activeWorkingSeconds)
            });
        }
        if (totalMachineAlarmSeconds > 0)
        {
            pieChartSegments.Add(new PieChartSegment
            {
                Label = "Makine Alarm",
                Color = "Crimson",
                DurationTimeSpan = TimeSpan.FromSeconds(totalMachineAlarmSeconds)
            });
        }
        if (totalOperatorPauseSeconds > 0)
        {
            pieChartSegments.Add(new PieChartSegment
            {
                Label = "Operatör Duraklama",
                Color = "Orange",
                DurationTimeSpan = TimeSpan.FromSeconds(totalOperatorPauseSeconds)
            });
        }

        if (!pieChartSegments.Any())
        {
            pieChartSegments.Add(new PieChartSegment { Label = "Veri Yok", Color = "Gray", DurationTimeSpan = TimeSpan.Zero });
        }
    }

    // WinForms'taki dgvStepDetails_CellFormatting mantığının karşılığı (satır stili)
    private string GetStepDurationStyle(ProductionStepDetailDto step) // DTO kullanıldı
    {
        // Çalışma zamanı string'ini TimeSpan'a çevir
        if (TimeSpan.TryParse(step.WorkingTime, out TimeSpan workingTime) && step.TheoreticalDurationSeconds > 0)
        {
            // TheoreticalDurationSeconds property'si kullanıldı
            TimeSpan theoreticalTime = TimeSpan.FromSeconds(step.TheoreticalDurationSeconds);

            int theoreticalMinutes = (int)theoreticalTime.TotalMinutes;
            int workingMinutes = (int)workingTime.TotalMinutes;

            if (workingMinutes > theoreticalMinutes)
            {
                return "background-color: #f8d7da; color: #721c24; border-left: 5px solid red;";
            }
            else if (workingMinutes < theoreticalMinutes)
            {
                return "background-color: #d4edda; color: #155724; border-left: 5px solid green;";
            }
        }
        return string.Empty;
    }

    // WinForms'taki btnExportToExcel_Click mantığının karşılığı
    private async Task ExportToExcel()
    {
        if (detailData == null) return;

        // Bu, Excel dosyasını sunucuda oluşturup istemciye indirmek için bir API çağrısıdır.
        // ScadaDataService'de ExportProductionDetailAsync(MachineId, BatchId) metodu olmalıdır.
        statusMessage = "Excel dosyası hazırlanıyor...";
        isLoading = true;
        StateHasChanged();

        try
        {
            var success = await ScadaDataService.ExportProductionDetailAsync(MachineId, BatchId);
            if (success)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Rapor Excel olarak başarıyla dışa aktarıldı (İndirme başlatıldı).");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Excel dışa aktarma başarısız oldu.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Dışa aktarma hatası: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
}