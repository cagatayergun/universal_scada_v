@using TekstilScada.Models
@using TekstilScada.WebApp.Services
@using TekstilScada.Core.Localization
@using Microsoft.Extensions.Localization
@using MudBlazor
@inject ScadaDataService ScadaService
@inject VncSessionService VncSessionService
@inject IJSRuntime JSRuntime
@inject IStringLocalizer<SharedResource> Loc
@implements IDisposable

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.DesktopWindows" Class="mr-3 mb-n1" />
            VNC (Otomatik Bağlantı)
        </MudText>
    </TitleContent>
    <DialogContent>
        @* --- DEBUG PANELİ --- *@
        @if (machine != null)
        {
            <div style="font-size:10px; color:#888; margin-bottom:5px;">
                <strong>Makine:</strong> @machine.MachineName <br />
                <strong>Hedef PLC IP:</strong> @machine.IpAddress <br />
                <strong>Algılanan Gateway:</strong> @gatewayDebugIp
            </div>
        }

        @if (isAccessDenied)
        {
            <MudAlert Severity="Severity.Warning">Erişim Reddedildi: @currentViewerName</MudAlert>
        }
        else if (machine == null)
        {
            <div class="d-flex flex-column justify-center align-center py-8" style="height: 300px;">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                <MudText Class="mt-4">Makine bilgileri ve IP adresi alınıyor...</MudText>
            </div>
        }
        else
        {
            <div style="width: 100%; height: 600px; display: flex; justify-content: center; align-items: center; background-color: #000; border: 1px solid #333;">
                <div id="@vncContainerId" class="vnc-cursor-fix" style="width: 100%; height: 100%;"></div>
            </div>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseConnection" Color="Color.Error" Variant="Variant.Filled">Kapat</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }
    [Parameter] public int MachineId { get; set; }

    private Machine? machine;
    private bool isConnected = false;
    private string vncContainerId = $"vnc-container-{Guid.NewGuid()}";

    private bool isAccessDenied = false;
    private string? currentViewerName;
    private string myUserName = "Operator";

    // Debug için ekranda göstermek adına
    private string gatewayDebugIp = "Bekleniyor...";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var machines = await ScadaService.GetMachinesAsync();
            if (machines != null)
            {
                machine = machines.FirstOrDefault(m => m.Id == MachineId);
            }

            var result = VncSessionService.TryEnterSession(MachineId, myUserName);
            if (!result.Success)
            {
                isAccessDenied = true;
                currentViewerName = result.CurrentUser;
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[VNC Init Hatası] {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (isAccessDenied || machine == null) return;

        if (!isConnected)
        {
            isConnected = true;
            string wsUrl = "";

            // --- OTOMATİK BAĞLANTI MANTIĞI ---

            // 1. ÖNCELİK: Veritabanında elle girilmiş "ws://" ile başlayan özel bir adres varsa onu kullan.
            // (VPN veya özel Proxy durumları için manuel override imkanı)
            if (!string.IsNullOrEmpty(machine.VncAddress) && (machine.VncAddress.StartsWith("ws://") || machine.VncAddress.StartsWith("wss://")))
            {
                wsUrl = machine.VncAddress;
                gatewayDebugIp = "Manuel DB Ayarı";
            }
            else
            {
                // 2. OTOMATİK: Hub'a sor, Gateway IP'sini öğren!
                string gatewayAddress = await ScadaService.GetGatewayIpAsync(MachineId);
                gatewayDebugIp = gatewayAddress; // Ekrana yazmak için

                // Hedef PLC IP'si (Veritabanından)
                string targetIp = !string.IsNullOrEmpty(machine.IpAddress) ? machine.IpAddress : "127.0.0.1";

                // URL OLUŞTUR: ws://[GatewayIP]/vnc/?target=[PlcIP]:5900
                wsUrl = $"ws://{gatewayAddress}/vnc/?target={targetIp}:5900";
            }

            Console.WriteLine($"[VNC] Bağlanılıyor: {wsUrl}");

            // Ekranda IP'yi güncellemek için render tetikle
            StateHasChanged();

            try
            {
                await JSRuntime.InvokeVoidAsync("startVnc", vncContainerId, wsUrl, machine.VncPassword ?? "");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[VNC JS Hatası] {ex.Message}");
                isConnected = false;
            }
        }
    }

    private void CloseConnection()
    {
        MudDialog.Close(DialogResult.Ok(true));
    }

    public async void Dispose()
    {
        if (isConnected)
        {
            try { await JSRuntime.InvokeVoidAsync("stopVnc", vncContainerId); } catch { }
        }

        if (!isAccessDenied)
        {
            VncSessionService.ExitSession(MachineId, myUserName);
        }
    }
}