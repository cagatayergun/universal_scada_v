@page "/makine-detay/{MachineId:int}"

@using TekstilScada.Models
@using TekstilScada.WebApp.Services
@using TekstilScada.Repositories
@using TekstilScada.Core.Localization
@using Microsoft.Extensions.Localization
@inject ScadaDataService ScadaDataService
@inject IJSRuntime JSRuntime
@inject IStringLocalizer<SharedResource> Loc
@implements IDisposable

<PageTitle>@string.Format(Loc["MakineDetayPageTitle"], MachineId, Status?.MachineName)</PageTitle>

@if (Status == null)
{
    <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">@Loc["Yukleniyor"]</span>
        </div>
        <p class="ms-3">@string.Format(Loc["MakineDurumuYukleniyor"], MachineId)</p>
    </div>
}
else
{
    <h1>@string.Format(Loc["MakineDetayiBaslik"], Status.MachineName, Status.MachineId)</h1>
    <hr />


    @* --- ANLIK DURUM KARTLARI --- *@
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card status-card @GetConnectionCssClass()">
                <div class="card-body"><h5 class="card-title">@Loc["BaglantiDurumu"]</h5><p class="card-text status-text">@Status.ConnectionState</p></div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">

            <div class="card status-card @GetProcessCssClass()">
                <div class="card-body"><h5 class="card-title">@Loc["UretimDurumu"]</h5><p class="card-text status-text">@GetStatusText()</p></div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card status-card">
                <div class="card-body">

                    <h5 class="card-title">@Loc["ProsesYuzdesi"]</h5>
                    <p class="card-text h1">@Status.ProsesYuzdesi%</p>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar" role="progressbar" style="width: @(Status.ProsesYuzdesi)%;"
                             aria-valuenow="@Status.ProsesYuzdesi" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card status-card @(Status.HasActiveAlarm ? "alarm-active" : "alarm-clear")">

                <div class="card-body">
                    <h5 class="card-title">@Loc["AktifAlarmBaslik"]</h5>
                    <p class="card-text status-text">
                        @(Status.HasActiveAlarm ? string.Format(Loc["AlarmNoFormat"], Status.ActiveAlarmNumber) : Loc["AlarmYok"])
                    </p>
                    @(Status.HasActiveAlarm ? $"({Status.ActiveAlarmText})" : "")
                </div>
            </div>
        </div>
    </div>

    @* --- ANLIK DEĞERLER (WinForms'dan eksik alanlar eklendi: Müşteri No, Sipariş No) --- *@
    <h2>@Loc["AnlikDegerler"]</h2>
    <div class="row">
        <div class="col-md-6">
            <ul class="list-group mb-3">
                <li class="list-group-item d-flex justify-content-between align-items-center">REÇETE ADI<span>@Status.RecipeName -</span></li> @* Bu kısım genelde veritabanından geldiği için çevirmedim, istenirse Loc["ReceteLabel"] kullanılabilir *@
                <li class="list-group-item d-flex justify-content-between align-items-center">PARTİ NO<span>@Status.BatchNumarasi -</span></li>
                <li class="list-group-item d-flex justify-content-between align-items-center">@Loc["OperatorLabel"]<span>@Status.OperatorIsmi -</span></li>
                <li class="list-group-item d-flex justify-content-between align-items-center">@Loc["MusteriNoLabel"]<span>@Status.MusteriNumarasi -</span></li>
                <li class="list-group-item d-flex justify-content-between align-items-center">@Loc["SiparisNoLabel"]<span>@Status.SiparisNumarasi  -</span></li>

            </ul>
        </div>
        <div class="col-md-6">
            <ul class="list-group mb-3">
                <li class="list-group-item d-flex justify-content-between align-items-center">@Loc["Sicaklik"]<span>@GetFormattedTemperature() °C</span></li>

                <li class="list-group-item d-flex justify-content-between align-items-center">@Loc["Devir"]<span>@Status.AnlikDevirRpm RPM</span></li>
                <li class="list-group-item d-flex justify-content-between align-items-center">@Loc["SuSeviyesiLabel"]<span>@Status.AnlikSuSeviyesi</span></li>
                <li class="list-group-item d-flex justify-content-between align-items-center">@Loc["AktifAdimLabel"]<span>@($"{Status.AktifAdimNo} - {Status.AktifAdimAdi}")</span></li>
            </ul>
        </div>
    </div>

    @* --- REÇETE ADIMLARI LİSTESİ --- *@
    <h3>@Loc["PlcReceteAdimlari"]</h3>
    @if (isLoadingRecipe)
    {
        <div class="alert alert-info">@Loc["ReceteAdimlariOkunuyor"]</div>
    }
    else
    {
        // Hata Düzeltme: Yerel değişken tanımını mevcut 'else' C# bloğunun içine taşıyoruz.
        var visibleRecipeSteps = RecipeSteps?
            .Where(s => GetStepTypeName(s) != Loc["TanimsizAdim"])
            .OrderBy(s => s.StepNumber)
            .ToList();

        if (visibleRecipeSteps == null || !visibleRecipeSteps.Any())
        {
            <div class="alert alert-warning">@Loc["AktifAdimBulunamadi"]</div>
        }
        else
        {
            <div class="recipe-steps-container table-responsive mb-4">
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <th style="width: 80px;">@Loc["AdimSutun"]</th>
                            <th>@Loc["AciklamaSutun"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var step in visibleRecipeSteps)
                        {
                            <tr class="@(step.StepNumber == Status.AktifAdimNo ? "table-success active-step-highlight" : "")">
                                <td>@step.StepNumber</td>
                                <td>@GetStepTypeName(step)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    }

    @* --- RAPORLAR VE GRAFİKLER İÇİN SEKME YAPISI --- *@
    <ul class="nav nav-tabs" id="detailTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link @(ActiveTab == "alarm" ? "active" : "")" @onclick="@(() => ChangeTab("alarm"))">
                @Loc["AlarmGecmisiTab"]
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(ActiveTab == "trend" ? "active" : "")" @onclick="@(() => ChangeTab("trend"))">
                @Loc["TrendAnaliziTab"]
            </button>
        </li>
    </ul>

    <div class="tab-content pt-3">
        @* ALARM GEÇMİŞİ SEKMESİ (WinForms'daki aktif alarm listesi mantığı eklendi) *@
        @if (ActiveTab == "alarm")
        {
            <div class="tab-pane active">

                <h3>@Loc["AktifAlarmDurumu"]</h3>
                @* WinForms'daki lstAlarmlar'ın canlı moda karşılığı*@
                @if (Status.HasActiveAlarm)
                {
                    <div class="alert alert-danger" role="alert">
                        <strong>@Loc["AktifAlarmLabel"]</strong> #@Status.ActiveAlarmNumber - @Status.ActiveAlarmText
                    </div>
                }
                else if (Status.ConnectionState == ConnectionStatus.Connected)
                {
                    <div class="alert alert-success" role="alert">
                        @Loc["AktifAlarmYok"]
                    </div>
                }
                else
                {
                    <div class="alert alert-warning" role="alert">
                        @Loc["BaglantiBekleniyorAlarm"]
                    </div>
                }

                <h3 class="mt-4">@Loc["AlarmGecmisiBaslik"]</h3>
                @if (isLoading)
                {
                    <p>@Loc["AlarmGecmisiYukleniyor"]</p>
                }
                else if (AlarmHistory == null || !AlarmHistory.Any())
                {
                    <div class="alert alert-info">@Loc["GecmisAlarmYok"]</div>
                }
                else
                {

                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>@Loc["BaslangicZamani"]</th>
                                    <th>@Loc["AlarmKodu"]</th>
                                    <th>@Loc["Aciklama"]</th>
                                    <th>@Loc["Sure"]</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var alarm in AlarmHistory.Take(50))
                                {
                                    <tr>
                                        <td>@alarm.StartTime.ToLocalTime()</td>
                                        <td>@alarm.AlarmNumber</td>
                                        <td>@alarm.AlarmText</td>
                                        <td>@alarm.Duration</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        }

        @* TREND ANALİZİ SEKMESİ (GRAFİK OLARAK YÜKLENİYOR) *@
        @if (ActiveTab == "trend")
        {
            <div class="tab-pane active">
                @if (isLoading)
                {
                    <p>@Loc["TrendVerileriYukleniyor"]</p>
                }
                else if (TrendData == null || !TrendData.Any())
                {
                    <div class="alert alert-info">@Loc["TrendVerisiYok"]</div>
                }
                else
                {

                    <h3>@Loc["CanliTrendGrafigi"]</h3>
                    <div id="trendChartContainer" style="width: 100%; height: 500px;">
                        @* Grafik bu div içine JavaScript ile çizilecektir *@
                        <div class="alert alert-success"></div>
                    </div>

                    @* Ham Veri Tablosu (Simülasyon) KALDIRILDI *@
                }
            </div>
        }
    </div>
}

@code {
    [Parameter]
    public int MachineId { get; set; }

    private FullMachineStatus? Status;
    private bool isSubscribed = false;

    // ReportFilters DTO'su, @using TekstilScada.Repositories ile çözümlenir.
    // Yerel tanım CS1503 hatasını çözmek için KALDIRILDI.

    // SEKME VE YÜKLEME YÖNETİMİ
    private string ActiveTab { get; set; } = "alarm";
    private bool isLoading = false;
    private bool isLoadingRecipe = false;
    private bool shouldRenderChart = false;

    // RAPOR MODELLERİ
    private List<AlarmReportItem>? AlarmHistory;
    private List<ScadaRecipeStep>? RecipeSteps;

    // TREND VERİSİ İÇİN YEREL ZENGİN DTO
    private List<TrendDataPointRich>? TrendData;
    // TREND VERİSİ İÇİN KULLANILAN ZENGİN DTO (Çoklu değişken tutar)
    public class TrendDataPointRich
    {
        public DateTime Timestamp { get; set; }
        public double TimestampOADate { get; set; } // KRİTİK EKLENTİ
        public double Temperature { get; set; } // decimal yerine double
        public double Rpm { get; set; } // decimal yerine double
        public double WaterLevel { get; set; } // decimal yerine double
    }

    protected override async Task OnInitializedAsync()
    {
        // Makine detaylarını ve anlık durumu al
        await ScadaDataService.GetMachinesAsync();
        // SignalR aboneliği
        ScadaDataService.OnDataUpdated += HandleDataUpdate;
        isSubscribed = true;

        await LoadRecipeStepsAsync();
        // Başlangıç sekmesi olan Alarm'ın verisini yüklüyoruz.
        await LoadReportData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Grafik çizimini yalnızca veri yüklendikten sonra ve bir kere çalıştır
        if (shouldRenderChart && TrendData != null && TrendData.Any() && ActiveTab == "trend")
        {
            shouldRenderChart = false;

            // Üç serili veriyi ve tek bir başlık string'ini gönderiyoruz
            await JSRuntime.InvokeVoidAsync("plotTrendChart1",
                "trendChartContainer", // HTML Div ID'si
                TrendData,
                Loc["CanliTrendAnalizi"].Value); // Başlık parametresi (Localized)
        }
    }

    private void HandleDataUpdate()
    {
        if (ScadaDataService.MachineData.TryGetValue(MachineId, out var newStatus))
        {
            Status = newStatus;
            InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadRecipeStepsAsync()
    {
        isLoadingRecipe = true;
        RecipeSteps = null;
        try
        {
            var recipe = await ScadaDataService.ReadRecipeFromPlcAsync(MachineId);
            if (recipe != null)
            {
                // ScadaRecipeStep'in TekstilScada.Models'den geldiği varsayılır.
                RecipeSteps = recipe.Steps.Where(s => s.StepNumber > 0).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Reçete adımları yüklenirken hata: {ex.Message}");
            RecipeSteps = new List<ScadaRecipeStep>();
        }
        isLoadingRecipe = false;
        StateHasChanged();
    }

    private async Task ChangeTab(string tabName)
    {
        if (ActiveTab != tabName)
        {
            ActiveTab = tabName;
            await LoadReportData();
        }
    }

    private async Task LoadReportData()
    {
        isLoading = true;
        shouldRenderChart = false;
        StateHasChanged();

        var defaultFilterData = new ReportFilters
        {
            StartTime = DateTime.Today.AddDays(-30),
            EndTime = DateTime.Now.AddHours(1),
            MachineId = MachineId
        };
        var trendFilterData = new ReportFilters
        {
            StartTime = DateTime.Now.AddMinutes(-100),
            EndTime = DateTime.Now.AddMinutes(1),
            MachineId = MachineId
        };
        try
        {
            if (ActiveTab == "alarm")
            {
                AlarmHistory = await ScadaDataService.GetAlarmReportAsync(defaultFilterData);
            }
            else if (ActiveTab == "trend")
            {
                var rawData = await ScadaDataService.GetTrendDataAsync(trendFilterData);
                if (rawData != null)
                {
                    try
                    {
                        var jsonString = System.Text.Json.JsonSerializer.Serialize(rawData);

                        // NOT: Gelen ham veri listesinin elemanları 'decimal' veya 'double' olabilir.
                        // Güvenli dönüşüm için System.Text.Json.JsonSerializer kullanmaya devam edelim.
                        var deserializedData = System.Text.Json.JsonSerializer.Deserialize<List<TrendDataPointRich>>(
                            jsonString,
                            new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true }
                        );

                        if (deserializedData != null)
                        {
                            // KRİTİK DÜZELTME: Tüm değerleri (sıcaklık dahil 10'a bölerek) double'a çevirip,
                            // zamanı da numerik OADate formatına dönüştürüyoruz.
                            TrendData = deserializedData.Select(d => new TrendDataPointRich
                            {
                                Timestamp = d.Timestamp,
                                TimestampOADate = d.Timestamp.ToOADate(), // KRİTİK: Numerik zaman
                                Temperature = (double)d.Temperature / 10.0, // Double cast ve bölme
                                Rpm = (double)d.Rpm, // Double cast
                                WaterLevel = (double)d.WaterLevel // Double cast
                            }).ToList();
                        }
                        else
                        {
                            TrendData = new List<TrendDataPointRich>();
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Trend verisi deserialization hatası: {ex.Message}");
                        TrendData = new List<TrendDataPointRich>();
                    }
                }
                else
                {
                    TrendData = new List<TrendDataPointRich>();
                }

                shouldRenderChart = TrendData.Any();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Rapor verisi yüklenirken hata: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // YARDIMCI METOTLAR:

    private string GetConnectionCssClass()
    {
        return Status?.ConnectionState switch
        {
            ConnectionStatus.Connected => "connected",
            ConnectionStatus.Connecting => "connecting",
            _ => "disconnected"
        };
    }

    private string GetProcessCssClass()
    {
        if (Status == null) return "bg-light";
        if (Status.HasActiveAlarm) return "alarm-active";
        if (Status.IsInRecipeMode) return "running";
        if (Status.IsPaused) return "paused";
        if (Status.manuel_status) return "manual";
        return "stopped";
    }

    private string GetStatusText()
    {
        if (Status == null || Status.ConnectionState != ConnectionStatus.Connected) return Loc["BaglantiYok"];
        if (Status.HasActiveAlarm) return $"{Loc["Alarm"]}: {Status.ActiveAlarmNumber} - {Status.ActiveAlarmText}";
        if (Status.IsPaused) return Loc["Duraklatildi"];
        if (Status.IsInRecipeMode) return $"{Loc["Calisiyor"]} - {Loc["AdimLabel"]} {Status.AktifAdimNo}";
        if (Status.manuel_status) return "MANUEL MOD"; // TODO: Localization key ekle
        return Loc["HazirDuruyor"];
    }

    private string GetFormattedTemperature()
    {
        return Status == null ?
        "-" : (Status.AnlikSicaklik / 10.0m).ToString("F1");
    }

    private string GetStepTypeName(ScadaRecipeStep step)
    {
        var stepTypes = new List<string>();
        short controlWord = step.StepDataWords.Length > 24 ? step.StepDataWords[24] : (short)0;
        if ((controlWord & 1) != 0) stepTypes.Add(Loc["AdimTipi_SuAlma"]);
        if ((controlWord & 2) != 0) stepTypes.Add(Loc["AdimTipi_Isitma"]);
        if ((controlWord & 4) != 0) stepTypes.Add(Loc["AdimTipi_Calisma"]);
        if ((controlWord & 8) != 0) stepTypes.Add(Loc["AdimTipi_Dozaj"]);
        if ((controlWord & 16) != 0) stepTypes.Add(Loc["AdimTipi_Bosaltma"]);
        if ((controlWord & 32) != 0) stepTypes.Add(Loc["AdimTipi_Sikma"]);
        return stepTypes.Any() ? string.Join(" + ", stepTypes) : Loc["TanimsizAdim"];
    }

    public void Dispose()
    {
        if (isSubscribed)
        {
            ScadaDataService.OnDataUpdated -= HandleDataUpdate;
        }
    }
}