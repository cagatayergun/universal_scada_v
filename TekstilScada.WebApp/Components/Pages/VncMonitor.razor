@using TekstilScada.Models
@using TekstilScada.WebApp.Services
@using TekstilScada.Core.Localization
@using Microsoft.Extensions.Localization
@using MudBlazor
@inject ScadaDataService ScadaService
@inject VncSessionService VncSessionService
@inject IJSRuntime JSRuntime
@inject IStringLocalizer<SharedResource> Loc
@implements IDisposable

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.DesktopWindows" Class="mr-3 mb-n1" />
            @if (machine != null)
            {
                @($"{Loc["UzaktanErisim"]} - {machine.MachineName}")
            }
            else
            {
                @Loc["UzaktanErisim"]
            }
        </MudText>
    </TitleContent>
    <DialogContent>
        @* --- DEBUG (Sadece geliştirme aşamasında açık kalsın) --- *@
        @if (machine != null)
        {
            <div style="font-size:10px; color:#888; margin-bottom:5px;">
                DB VncAddress: @machine.VncAddress | DB IpAddress: @machine.IpAddress
            </div>
        }

        @if (isAccessDenied)
        {
            <MudAlert Severity="Severity.Warning">Erişim Reddedildi: @currentViewerName</MudAlert>
        }
        else if (machine == null)
        {
            <div class="d-flex flex-column justify-center align-center py-8" style="height: 300px;">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                <MudText Class="mt-4">Makine bilgileri yükleniyor...</MudText>
            </div>
        }
        else
        {
            @* --- VNC EKRANI --- *@
            <div style="width: 100%; height: 600px; display: flex; justify-content: center; align-items: center; background-color: #000; border: 1px solid #333;">
                <div id="@vncContainerId" class="vnc-cursor-fix" style="width: 100%; height: 100%;"></div>
            </div>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseConnection" Color="Color.Error" Variant="Variant.Filled">Kapat</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }
    [Parameter] public int MachineId { get; set; }

    private Machine? machine;
    private bool isConnected = false;
    private string vncContainerId = $"vnc-container-{Guid.NewGuid()}";

    private bool isAccessDenied = false;
    private string? currentViewerName;
    private string myUserName = "Operator";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // API'den verileri çek
            var machines = await ScadaService.GetMachinesAsync();
            if (machines != null)
            {
                machine = machines.FirstOrDefault(m => m.Id == MachineId);
            }

            // Kilit Kontrolü
            var result = VncSessionService.TryEnterSession(MachineId, myUserName);
            if (!result.Success)
            {
                isAccessDenied = true;
                currentViewerName = result.CurrentUser;
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            //($"[VNC Init Hatası] {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (isAccessDenied || machine == null) return;

        if (!isConnected)
        {
            isConnected = true;
            string wsUrl = "";

            // --- ADRES OLUŞTURMA MANTIĞI ---

            // 1. Durum: VncAddress içinde "ws://" varsa (Tam adres) -> Direkt kullan
            if (!string.IsNullOrEmpty(machine.VncAddress) && (machine.VncAddress.StartsWith("ws://") || machine.VncAddress.StartsWith("wss://")))
            {
                wsUrl = machine.VncAddress;
                //($"[VNC] Tam Adres Kullanılıyor: {wsUrl}");
            }
            // 2. Durum: VncAddress içinde IP:Port varsa (Örn: 192.168.1.50:5901) -> Proxy formatına çevir
            else if (!string.IsNullOrEmpty(machine.VncAddress) && machine.VncAddress.Contains(":"))
            {
                // VncAddress = Gateway IP'si ve Portu (WinForms PC)
                string gatewayAddress = machine.VncAddress;

                // Target IP = PLC IP'si (Machine tablosundaki IpAddress)
                string targetIp = !string.IsNullOrEmpty(machine.IpAddress) ? machine.IpAddress : "127.0.0.1";

                // URL: ws://GatewayIP:Port/vnc/?target=PlcIP:5900
                wsUrl = $"ws://{gatewayAddress}/vnc/?target={targetIp}:5900";

                //($"[VNC] Dinamik Adres Üretildi: {wsUrl}");
            }
            // 3. Durum: VncAddress boşsa -> Localhost varsay (Geliştirme ortamı)
            else
            {
                string targetIp = !string.IsNullOrEmpty(machine.IpAddress) ? machine.IpAddress : "127.0.0.1";
                wsUrl = $"ws://localhost:5901/vnc/?target={targetIp}:5900";
                //($"[VNC] Localhost Varsayılanı Kullanılıyor: {wsUrl}");
            }

            try
            {
                await JSRuntime.InvokeVoidAsync("startVnc", vncContainerId, wsUrl, machine.VncPassword ?? "");
            }
            catch (Exception ex)
            {
                //($"[VNC JS Hatası] {ex.Message}");
                isConnected = false;
            }
        }
    }

    private void CloseConnection()
    {
        MudDialog.Close(DialogResult.Ok(true));
    }

    public async void Dispose()
    {
        if (isConnected)
        {
            try { await JSRuntime.InvokeVoidAsync("stopVnc", vncContainerId); } catch { }
        }

        if (!isAccessDenied)
        {
            VncSessionService.ExitSession(MachineId, myUserName);
        }
    }
}