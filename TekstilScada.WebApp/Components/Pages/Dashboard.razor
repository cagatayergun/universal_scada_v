@page "/dashboard"
@page "/"
@rendermode InteractiveServer
@using TekstilScada.WebApp.Services
@using TekstilScada.Models
@using TekstilScada.WebApp.Components.Shared
@using TekstilScada.Core.Localization
@using Microsoft.Extensions.Localization
@using System.Globalization @* <-- CultureInfo için gerekli *@
@inject ScadaDataService ScadaService
@inject NavigationManager NavManager
@inject IStringLocalizer<SharedResource> Loc

@implements IDisposable

<div class="dashboard-container">

    @if (_isLoading)
    {
        <div class="loading-overlay">
            <p>@Loc["VerilerYukleniyor"]</p>
        </div>
    }
    else
    {
        <div class="kpi-cards-row">
            <KpiCard Title="@Loc["ToplamMakine"]" Value="@TotalMachines.ToString()" CssClass="kpi-info" />
            <KpiCard Title="@Loc["AktifMakine"]" Value="@RunningMachines.ToString()" CssClass="kpi-success" />
            <KpiCard Title="@Loc["AlarmdakiMakine"]" Value="@AlarmMachines.ToString()" CssClass="kpi-danger" />
            <KpiCard Title="@Loc["BekleyenMakine"]" Value="@IdleMachines.ToString()" CssClass="kpi-warning" />
        </div>

        <div class="main-content-area">
            <div class="machine-groups-column">
                @if (TotalMachines == 0)
                {
                    <p>@Loc["MakineTanimlanmamis"]</p>
                }
                else
                {
                    @foreach (var group in GroupedMachines)
                    {
                        <div class="machine-group-box" style="--group-color: @GetGroupColor(group.Key)">
                            <div class="group-title">@group.Key</div>
                            <div class="group-inner-panel" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                @foreach (var machineStatus in group)
                                {
                                    <DashboardMachineCard MachineStatus="machineStatus"
                                                          @key="machineStatus.MachineId"
                                                          MouseClick="() => NavigateToDetail(machineStatus.MachineId)" />
                                }
                            </div>
                        </div>
                    }
                }
            </div>

            <div class="sidebar-charts-column pl-2" style="min-width: 300px;">

                <MudPaper Class="chart-box pa-2 mb-2" Elevation="2" Style="background-color: #1e1e2d;">
                    <div id="oeeChartContainer" style="width:100%; height:250px;"></div>
                    @if (!HourlyOeeData.Any())
                    {
                        <MudText Typo="Typo.caption" Align="MudBlazor.Align.Center" Class="d-block text-muted">@Loc["VeriBekleniyor"]</MudText>
                    }
                </MudPaper>

                <MudPaper Class="chart-box pa-2 mb-2" Elevation="2" Style="background-color: #1e1e2d;">
                    <div id="electricChartContainer" style="width:100%; height:250px;"></div>
                </MudPaper>

                <MudPaper Class="chart-box pa-2 mb-2" Elevation="2" Style="background-color: #1e1e2d;">
                    <div id="waterChartContainer" style="width:100%; height:250px;"></div>
                </MudPaper>

                <MudPaper Class="chart-box pa-2 mb-2" Elevation="2" Style="background-color: #1e1e2d;">
                    <div id="steamChartContainer" style="width:100%; height:250px;"></div>
                </MudPaper>

                <MudPaper Class="chart-box pa-2 mb-2" Elevation="2" Style="background-color: #1e1e2d;">
                    <div id="topAlarmsChartContainer" style="width:100%; height:250px;"></div>
                </MudPaper>

            </div>
        </div>
    }
</div>

@code {
    [Inject]
    public IJSRuntime JSRuntime { get; set; }

    private List<IGrouping<string, FullMachineStatus>> GroupedMachines = new();
    private bool _isLoading = true;
    private bool _isDisposed = false;
    private bool _shouldRenderCharts = false;

    // KULLANICI DİLİNİ SAKLAMAK İÇİN DEĞİŞKEN
    private CultureInfo _userCulture;

    // Sidebar verileri
    private List<HourlyConsumptionData> HourlyConsumptionData = new();
    private List<HourlyOeeData> HourlyOeeData = new();
    private List<TopAlarmData> TopAlarms = new();

    // KPI Alanları
    private int TotalMachines = 0;
    private int RunningMachines = 0;
    private int AlarmMachines = 0;
    private int IdleMachines = 0;

    private readonly List<string> DarkColors = new List<string>
    {
        "#2c3e50", "#2ecc71", "#e74c3c", "#9b59b6", "#3498db",
        "#f1c40f", "#16a085", "#c0392b", "#2980b9", "#f39c12",
    };
    private Dictionary<string, string> GroupColors = new Dictionary<string, string>();
    private int _colorIndex = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 1. ADIM: Sayfa ilk açıldığında (doğru dil varken) bu dili yakalıyoruz.
            _userCulture = CultureInfo.CurrentUICulture;

            await ScadaService.InitializeAsync();
            await ScadaService.GetMachinesAsync();
            ScadaService.OnDataUpdated += HandleDataUpdate;

            await LoadSidebarDataAsync();
            UpdateDashboardData();

            _isLoading = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Dashboard Yükleme Hatası: {ex.Message}");
            _isLoading = false;
        }

        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_shouldRenderCharts)
        {
            _shouldRenderCharts = false;

            try
            {
                await JSRuntime.InvokeVoidAsync("plotDashboardCharts",
                    HourlyOeeData,
                    HourlyConsumptionData,
                    TopAlarms);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"JS Grafik Çizimi Hatası: {ex.Message}");
            }
        }
    }

    private async Task LoadSidebarDataAsync()
    {
        HourlyConsumptionData = await ScadaService.GetHourlyConsumptionAsync() ?? new();
        HourlyOeeData = await ScadaService.GetHourlyOeeAsync() ?? new();
        TopAlarms = await ScadaService.GetTopAlarmsAsync() ?? new();

        _shouldRenderCharts = true;
    }

    private void UpdateDashboardData()
    {
        var allStatuses = ScadaService.MachineData.Values.ToList();
        foreach (var status in allStatuses)
        {
            if (ScadaService.MachineDetailsCache.TryGetValue(status.MachineId, out var machineDetails))
            {
                status.MakineTipi = machineDetails.MachineSubType;
            }
        }

        TotalMachines = allStatuses.Count;
        RunningMachines = allStatuses.Count(s => s.IsInRecipeMode && !s.HasActiveAlarm);
        AlarmMachines = allStatuses.Count(s => s.HasActiveAlarm);
        IdleMachines = TotalMachines - RunningMachines - AlarmMachines;

        if (TotalMachines == 0)
        {
            GroupedMachines = new List<IGrouping<string, FullMachineStatus>>();
            return;
        }

        var sortedMachines = allStatuses
            .OrderByDescending(m => m.IsInRecipeMode)
            .ThenBy(m => m.HasActiveAlarm)
            .ThenBy(m => m.MachineName);

        GroupedMachines = sortedMachines
             .GroupBy(m => string.IsNullOrEmpty(m.MakineTipi) ? "Diğer" : m.MakineTipi)
             .OrderByDescending(g => g.Any(m => m.IsInRecipeMode))
             .ThenBy(g => g.Key)
             .ToList();

        if (GroupColors.Count != GroupedMachines.Count)
        {
            _colorIndex = 0;
            GroupColors.Clear();
            foreach (var group in GroupedMachines)
            {
                GroupColors.TryAdd(group.Key, DarkColors[_colorIndex % DarkColors.Count]);
                _colorIndex++;
            }
        }
    }

    private void HandleDataUpdate()
    {
        try
        {
            if (_isDisposed) return;

            // 2. ADIM: Arka plan servisinden güncelleme geldiğinde,
            // thread'in dilini, kullanıcının kaydettiğimiz dili ile değiştiriyoruz.
            if (_userCulture != null)
            {
                CultureInfo.CurrentCulture = _userCulture;
                CultureInfo.CurrentUICulture = _userCulture;
            }

            UpdateDashboardData();
            _shouldRenderCharts = true;
            InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"!!! KRİTİK VERİ GÜNCELLEME HATASI: {ex.Message}");
        }
    }

    private void NavigateToDetail(int machineId)
    {
        NavManager.NavigateTo($"/proseskontrol/{machineId}");
    }

    private string GetGroupColor(string groupKey)
    {
        return GroupColors.TryGetValue(groupKey, out var color) ? color : "#6c757d";
    }

    public void Dispose()
    {
        _isDisposed = true;
        ScadaService.OnDataUpdated -= HandleDataUpdate;
    }
}