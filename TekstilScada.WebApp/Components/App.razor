<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <link rel="stylesheet" href="bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="app.css" />
    <link rel="stylesheet" href="TekstilScada.WebApp.styles.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <link href="_content/MudBlazor/MudBlazor.min.css" rel="stylesheet" />
    
    <HeadOutlet @rendermode="@(new InteractiveServerRenderMode(prerender: false))" />
</head>

<body>
    <CascadingAuthenticationState>
        <Routes @rendermode="@(new InteractiveServerRenderMode(prerender: false))" />
    </CascadingAuthenticationState>
    
    <script src="_framework/blazor.web.js"></script>
    <script src="_content/MudBlazor/MudBlazor.min.js"></script>
    <script src="_content/Blazor-ApexCharts/js/apex-charts.min.js"></script>
    <script src="_content/Blazor-ApexCharts/js/blazor-apex-charts.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.31.1.min.js"></script>

    <script>
        // --- 1. ORTAK AYARLAR ---
        function getCommonLayout(title, yTitle, isMobile) {
            return {
                title: {
                    text: title,
                    font: { size: isMobile ? 12 : 14, color: '#e0e0e0' },
                    y: 0.95
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { size: isMobile ? 9 : 11, color: '#b0b0b0' },
                margin: { t: 30, b: isMobile ? 25 : 40, l: isMobile ? 30 : 40, r: 10 },
                autosize: true,
                xaxis: { 
                    tickcolor: '#9e9e9e', gridcolor: '#333', gridwidth: 0.5,
                    tickangle: isMobile ? 0 : -45, automargin: true 
                },
                yaxis: { 
                    title: { text: yTitle }, tickcolor: '#9e9e9e',
                    gridcolor: '#333', gridwidth: 0.5, zeroline: false, automargin: true 
                },
                showlegend: false
            };
        }

        // --- 2. DASHBOARD GRAFİKLERİ ---
        function plotDashboardCharts(hourlyOeeData, hourlyConsumptionData, topAlarmsData) {
            if (typeof Plotly === 'undefined') {
                setTimeout(() => plotDashboardCharts(hourlyOeeData, hourlyConsumptionData, topAlarmsData), 500);
                return;
            }
            const isMobile = window.innerWidth <= 768;
            const config = { displayModeBar: false, responsive: true };

            // OEE
            const oeeContainer = document.getElementById('oeeChartContainer');
            if (oeeContainer) {
                const data = hourlyOeeData.length > 0 ? hourlyOeeData.map(d => ({ hour: d.saat, oee: d.averageOEE })) : [{ hour: 0, oee: 0 }];
                const trace = { x: data.map(d => `${d.hour}:00`), y: data.map(d => d.oee), type: 'bar', marker: { color: data.map(d => d.oee < 50 ? '#e74c3c' : '#2ecc71') } };
                const layout = getCommonLayout('', 'OEE (%)', isMobile);
                layout.yaxis.range = [0, 100];
                Plotly.newPlot(oeeContainer, [trace], layout, config);
            }

            // Tüketimler
            const plotCons = (id, key, unit, color) => {
                const container = document.getElementById(id);
                if (!container) return;
                const values = hourlyConsumptionData.map(d => d[key]);
                const trace = { x: hourlyConsumptionData.map(d => `${d.hour}:00`), y: values, type: 'scatter', mode: 'lines+markers', fill: 'tozeroy', line: { color: color, width: 2 } };
                Plotly.newPlot(container, [trace], getCommonLayout('', unit, isMobile), config);
            };
            plotCons('electricChartContainer', 'toplamElektrik', 'kWh', '#00bcd4');
            plotCons('waterChartContainer', 'toplamSu', 'Litre', '#2196f3');
            plotCons('steamChartContainer', 'toplamBuhar', 'kg', '#9c27b0');

            // Alarmlar
            const alarmContainer = document.getElementById('topAlarmsChartContainer');
            if (alarmContainer) {
                const data = topAlarmsData.slice(0, 5);
                const trace = { x: data.map(d => d.count), y: data.map(d => d.alarmText.substring(0, isMobile ? 15 : 25) + '...'), type: 'bar', orientation: 'h', marker: { color: '#ff5722' } };
                const layout = getCommonLayout('', '', isMobile);
                layout.margin.l = isMobile ? 80 : 150;
                Plotly.newPlot(alarmContainer, [trace], layout, config);
            }
        }

        // --- 3. PASTA GRAFİK (EKSİK OLAN BU İDİ) ---
        function drawPieChart(elementId, chartData) {
            if (!document.getElementById(elementId)) return;
            if (!chartData || chartData.length === 0) { Plotly.purge(elementId); return; }

            const data = [{
                values: chartData.map(d => d.value),
                labels: chartData.map(d => d.label),
                type: 'pie',
                marker: { colors: chartData.map(d => d.color) },
                hoverinfo: 'label+percent+text',
                text: chartData.map(d => {
                    const v = d.value;
                    const h = Math.floor(v / 3600).toString().padStart(2,'0');
                    const m = Math.floor((v % 3600) / 60).toString().padStart(2,'0');
                    return `${h}:${m}`;
                }),
                textinfo: 'percent',
                hole: .4
            }];

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#e0e0e0' },
                height: 250,
                margin: { t: 10, b: 10, l: 10, r: 10 },
                showlegend: true,
                legend: { font: { color: '#b0b0b0' } }
            };
            Plotly.newPlot(elementId, data, layout, { responsive: true, displayModeBar: false });
        }

        // --- 4. ZAMAN ÇİZGİSİ (EKSİK OLAN) ---
        function drawTimelineChart(elementId, chartData) {
             if (!document.getElementById(elementId)) return;
             if (!chartData || chartData.length === 0) { Plotly.purge(elementId); return; }

             const steps = chartData.map(d => `Adım ${d.stepNumber}\n${d.description.substring(0,10)}`);
             const trace = {
                 x: steps, y: chartData.map(d => d.temperature),
                 mode: 'lines+markers', type: 'scatter', name: 'Sıcaklık', line: { color: '#e74c3c', width: 2 }
             };
             
             const layout = getCommonLayout('Adım Sıcaklık Trendi', 'Sıcaklık (°C)', window.innerWidth <= 768);
             layout.xaxis.tickangle = 45;
             Plotly.newPlot(elementId, [trace], layout, { responsive: true });
        }

        // --- 5. DETAY VE TREND GRAFİKLERİ ---
        function plotTrendChart(chartId, dataPoints, selectedData) {
            if (!document.getElementById(chartId)) return;
            if (!dataPoints) dataPoints = [];
            const x = dataPoints.map(p => p.timestamp);
            let y, title, color;
            switch (selectedData) {
                case 'Temperature': y = dataPoints.map(p => p.temperature/10.0); title='Sıcaklık'; color='#f44336'; break;
                case 'WaterLevel': y = dataPoints.map(p => p.waterLevel); title='Seviye'; color='#2196f3'; break;
                case 'Rpm': y = dataPoints.map(p => p.rpm); title='Devir'; color='#4caf50'; break;
                default: return;
            }
            const trace = { x: x, y: y, mode: 'lines', line: { color: color, width: 2 } };
            Plotly.newPlot(chartId, [trace], getCommonLayout(title, title, false), { responsive: true, displayModeBar: false });
        }

        function plotTrendChart1(chartId, dataPoints, title) {
            if (!document.getElementById(chartId)) return;
            if (!dataPoints) dataPoints = [];
            const x = dataPoints.map(p => p.timestamp);
            
            const t1 = { x:x, y:dataPoints.map(d=>d.temperature), name:'Sıcaklık', type:'scatter', line:{color:'#e74c3c'}, yaxis:'y1' };
            const t2 = { x:x, y:dataPoints.map(d=>d.rpm), name:'Devir', type:'scatter', line:{color:'#3498db'}, yaxis:'y2' };
            const t3 = { x:x, y:dataPoints.map(d=>d.waterLevel), name:'Seviye', type:'scatter', line:{color:'#2ecc71'}, yaxis:'y3' };

            const layout = getCommonLayout(title||'Canlı Trend', 'Sıcaklık', false);
            layout.yaxis.gridcolor='#444';
            layout.yaxis2={ title:'Devir', overlaying:'y', side:'right', position:0.98, showgrid:false, tickfont:{color:'#3498db'} };
            layout.yaxis3={ title:'Seviye', overlaying:'y', side:'right', position:0.90, showgrid:false, tickfont:{color:'#2ecc71'} };
            layout.showlegend=true;
            layout.legend={ x:0, y:1.1, orientation:'h', font:{color:'#ccc'} };

            Plotly.newPlot(chartId, [t1, t2, t3], layout, { responsive: true });
        }

        // --- 6. EXCEL İNDİRME ---
        window.saveAsFile = function (filename, bytesBase64) {
            const link = document.createElement('a');
            link.download = filename;
            link.href = "data:application/octet-stream;base64," + bytesBase64;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
    </script>
</body>
</html>