<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <link rel="stylesheet" href="bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="app.css" />

    <link rel="stylesheet" href="TekstilScada.WebApp.styles.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <HeadOutlet @rendermode="new InteractiveServerRenderMode(prerender: false)" />
    <script src="https://cdn.plot.ly/plotly-2.31.1.min.js"></script>
</head>
<script>
    // Blazor'dan gelen veriyi alan ve Plotly ile grafiği çizen fonksiyon
    // TekstilScada.WebApp/Components/App.razor - <script> bloğu içinde

     // TekstilScada.WebApp/Components/App.razor - <script> bloğu içinde

    function plotTrendChart(chartId, dataPoints, selectedData) {
        if (!dataPoints || dataPoints.length === 0) {
            console.log("Grafik çizmek için veri yok.");
            Plotly.purge(chartId);
            return;
        }

        // KRİTİK DÜZELTME: Tüm özellikler camelCase (küçük harfle başlayan) olarak erişilmelidir.
        const timestamps = dataPoints.map(p => p.timestamp);
        let values;
        let yaxisTitle;

        switch (selectedData) {
            case 'Temperature':
                // C# (Temperature) -> JS (temperature)
                values = dataPoints.map(p => p.temperature / 10.0);
                yaxisTitle = 'Sıcaklık (°C)';
                break;
            case 'WaterLevel':
                // C# (WaterLevel) -> JS (waterLevel)
                values = dataPoints.map(p => p.waterLevel);
                yaxisTitle = 'Su Seviyesi';
                break;
            case 'Rpm':
                // C# (Rpm) -> JS (rpm)
                values = dataPoints.map(p => p.rpm);
                yaxisTitle = 'Devir (Rpm)';
                break;
            default:
                console.error("Geçersiz veri tipi.");
                return;
        }

        // TANI: Değerlerin gerçekten gelip gelmediğini kontrol eder.
        console.log(`Plotly çizim verisi kontrolü: Times (${timestamps.length} adet), Values (${values.length} adet)`);

        if (values.every(v => v === undefined || v === null)) {
             console.error("HATA: Değer dizisi boş veya tanımsız. JSON serileştirme hatası devam ediyor.");
             Plotly.purge(chartId);
             return;
        }


        const trace = {
            x: timestamps,
            y: values,
            mode: 'lines',
            type: 'scatter',
            name: selectedData
        };

        const layout = {
            title: `Trend Analizi: ${yaxisTitle} - Makine ${dataPoints[0].machineId}`,
            xaxis: {
                title: 'Zaman Damgası',
                type: 'date'
            },
            yaxis: {
                title: yaxisTitle
            }
        };

        Plotly.newPlot(chartId, [trace], layout, { responsive: true });
    }
</script>
<script>
   

    // Blazor'dan gelen ÜÇ SERİLİ veriyi alan ve Plotly ile grafiği çizen fonksiyon
    function plotTrendChart1(chartId, dataPoints, title) {
        if (!dataPoints || dataPoints.length === 0) {
            console.log("Grafik çizmek için veri yok.");
            Plotly.purge(chartId);
            return;
        }
         const timestamps = dataPoints.map(p => p.timestamp);
    
        // 1. Veri Hazırlama: TimestampOADate'i Date objesine çeviriyoruz.
        const xTime = timestamps;
        const yTemp = dataPoints.map(d => d.temperature);
        const yRpm = dataPoints.map(d => d.rpm);
        const yWater = dataPoints.map(d => d.waterLevel);

        // 2. Grafik Serileri (Traces)
        const traceTemp = {
            x: xTime,
            y: yTemp,
            name: 'Sıcaklık (°C)',
            type: 'scatter',
            mode: 'lines',
            line: { color: 'red' },
            yaxis: 'y1'
        };

        const traceRpm = {
            x: xTime,
            y: yRpm,
            name: 'Devir (RPM)',
            type: 'scatter',
            mode: 'lines',
            line: { color: 'blue' },
            yaxis: 'y2'
        };

        const traceWater = {
            x: xTime,
            y: yWater,
            name: 'Su Seviyesi',
            type: 'scatter',
            mode: 'lines',
            line: { color: 'green' },
            yaxis: 'y3'
        };

        // 3. Grafik Düzeni (Layout)
        const layout = {
            title: title || 'Canlı Proses Trend Grafiği',
            xaxis: {
                title: 'Zaman Damgası',
                type: 'timestamps', // Artık Plotly'ye Date objeleri gönderdiğimiz için bu doğru çalışacaktır.
                tickformat: '%Y-%m-%d\n%H:%M:%S' // Zaman formatını göster
            },
            yaxis: {
                title: 'Sıcaklık (°C)',
                showgrid: true,
                zeroline: true,
                side: 'left',
                automargin: true,
            },
            yaxis2: {
                title: 'Devir (RPM)',
                overlaying: 'y',
                side: 'right',
                showgrid: false,
                zeroline: false,
                automargin: true,
                position: 0.98, // Devir ekseni pozisyonu (sağdan 2%)
            },
            yaxis3: {
                title: 'Su Seviyesi',
                overlaying: 'y',
                side: 'right',
                position: 0.90, // Su seviyesi ekseni pozisyonu (sağdan 10%)
                showgrid: false,
                zeroline: false,
                automargin: true,
            },
            margin: { r: 0, b: 0 } // Sağ ve alt kenar boşluklarını artır
        };

        Plotly.newPlot(chartId, [traceTemp, traceRpm, traceWater], layout, { responsive: true });
    }
        // Bu fonksiyonu App.razor veya sitenizdeki bir JS dosyasına ekleyin

    function plotDashboardCharts(hourlyOeeData, hourlyConsumptionData, topAlarmsData) {
        if (!Plotly) {
            console.error("Plotly kütüphanesi yüklenmedi.");
            return;
        }

        // 1. OEE Grafiği (Bar Chart)
        const plotOee = () => {
            const containerId = 'oeeChartContainer';
            const data = hourlyOeeData.map(d => ({ hour: d.saat, oee: d.averageOEE }));

            if (data.length === 0) return Plotly.purge(containerId);

            const trace = {
                x: data.map(d => `${d.hour}:00`),
                y: data.map(d => d.oee),
                type: 'bar',
                marker: { color: 'rgba(46, 204, 113, 0.8)' }, // kpi-success rengi
                name: 'Ortalama OEE (%)'
            };

            const layout = {
              
                xaxis: { title: 'Saat', tickangle: 45 },
                yaxis: { title: 'OEE (%)', range: [0, 100] },
                margin: { t: 30, b: 0, l: 0, r: 0 },
                height: 250 // Dashboard görünümüne uygun yükseklik
                
            };

            Plotly.newPlot(containerId, [trace], layout, { displayModeBar: false, responsive: true });
        };

        // 2. Tüketim Grafikleri (Bar Chart - Gruplandırılmış)
        const plotConsumption = (containerId, consumptionKey, title, unit, color) => {
            const data = hourlyConsumptionData;

            if (data.length === 0) return Plotly.purge(containerId);

            // consumptionKey'i kullanarak ilgili tüketim değerini al
            const values = data.map(d => d[consumptionKey]);

            const trace = {
                x: data.map(d => `${d.saat}:00`),
                y: values,
                type: 'bar',
                marker: { color: color },
                name: title
            };

            const layout = {
                title: title,
                xaxis: { title: 'Saat', tickangle: 45 },
                yaxis: { title: unit, automargin: true },
                 margin: { t: 30, b: 0, l: 0, r: 0 },
                height: 250
            };

            Plotly.newPlot(containerId, [trace], layout, { displayModeBar: false, responsive: true });
        };

        // 3. En Sık Alarmlar Grafiği (Yatay Bar Chart)
        const plotTopAlarms = () => {
            const containerId = 'topAlarmsChartContainer';
            const data = topAlarmsData.sort((a, b) => a.count - b.count).slice(-5); // En çok tekrar eden 5 alarm

            if (data.length === 0) return Plotly.purge(containerId);

            const trace = {
                x: data.map(d => d.count),
                y: data.map(d => d.alarmText.length > 20 ? d.alarmText.substring(0, 17) + '...' : d.alarmText), // Uzun isimleri kısalt
                type: 'bar',
                orientation: 'h', // Yatay bar
                marker: { color: 'rgba(231, 76, 60, 0.8)' }, // kpi-danger rengi
                name: 'Tekrar Sayısı'
            };

            const layout = {
               
                xaxis: { title: 'Tekrar Sayısı', automargin: true },
                yaxis: { automargin: true },
                margin: { t: 30, b: 40, l: 150, r: 0 }, // Solda alarm isimleri için geniş boşluk
                height: 250
            };

            Plotly.newPlot(containerId, [trace], layout, { displayModeBar: false, responsive: true });
        };


        // Tüm grafikleri çağır
        plotOee();
        plotConsumption('electricChartContainer', 'toplamElektrik', '', 'kWh', '#3498db');
        plotConsumption('waterChartContainer', 'toplamSu', '', 'Litre', '#2c3e50');
        plotConsumption('steamChartContainer', 'toplamBuhar', '', 'kg', '#9b59b6');
        plotTopAlarms();
    }
       
</script>

<body>
    @* Sadece bir <Routes /> olmalı ve CascadingAuthenticationState'in içinde kalmalı *@
    <CascadingAuthenticationState>
        <Routes @rendermode="new InteractiveServerRenderMode(prerender: false)" />
    </CascadingAuthenticationState>
    
    <script src="_framework/blazor.web.js"></script>
</body>
</html>
