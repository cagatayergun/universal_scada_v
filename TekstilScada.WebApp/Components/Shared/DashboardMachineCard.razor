@using TekstilScada.Models
@using TekstilScada.Core.Models
@using MudBlazor

<MudCard Elevation="3" Class="ma-2 machine-card-hover pa-1" Style="@GetCardStyle()" @onclick="OnClickCallback">

    <MudCardHeader Class="pb-2 pt-2">
        <CardHeaderAvatar>
            <MudAvatar Color="@GetStatusColor()" Variant="Variant.Filled" Size="MudBlazor.Size.Medium">
                <MudIcon Icon="@Icons.Material.Filled.PrecisionManufacturing" Size="MudBlazor.Size.Medium" />
            </MudAvatar>
        </CardHeaderAvatar>
        <CardHeaderContent>
            <MudText Typo="Typo.subtitle2" Style="font-weight:bold; line-height:1.2;">@MachineStatus.MachineName</MudText>
            <MudText Typo="Typo.caption" Class="mud-text-secondary">@MachineStatus.MachineType</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            @if (MachineStatus.HasActiveAlarm)
            {
                <MudTooltip Text="@MachineStatus.ActiveAlarmText">
                    <MudChip T="string" Size="MudBlazor.Size.Small" Color="MudBlazor.Color.Error" Icon="@Icons.Material.Filled.Warning">ALARM</MudChip>
                </MudTooltip>
            }
            else
            {
                <MudChip T="string" Size="MudBlazor.Size.Small" Color="@GetStatusColor()" Variant="Variant.Text" Class="mt-1">@GetStatusText()</MudChip>
            }
        </CardHeaderActions>
    </MudCardHeader>

    <MudCardContent Class="pt-1 pb-2">

        @if (MachineStatus.ConnectionState != ConnectionStatus.Connected)
        {
            <div class="d-flex flex-column align-center justify-center py-4" style="opacity:0.6">
                <MudIcon Icon="@Icons.Material.Filled.WifiOff" Color="MudBlazor.Color.Error" Size="MudBlazor.Size.Large" />
                <MudText Typo="Typo.body2" Color="MudBlazor.Color.Error" Class="mt-1">Bağlantı Yok</MudText>
            </div>
        }
        else
        {
            @if (MachineStatus.IsInRecipeMode)
            {
                <div class="mb-2 px-2 py-1 rounded" style="background-color:var(--mud-palette-background-grey);">
                    <div class="d-flex justify-space-between">
                        <MudText Typo="Typo.caption"><b>Batch:</b> @MachineStatus.BatchNumarasi</MudText>
                        <MudText Typo="Typo.caption"><b>Adım:</b> @MachineStatus.AktifAdimNo</MudText>
                    </div>
                    <MudText Typo="Typo.caption" Class="d-block text-truncate">@MachineStatus.AktifAdimAdi</MudText>
                </div>
            }
            else
            {
                <div class="mb-2 px-2 py-2 rounded d-flex align-center justify-center" style="background-color:var(--mud-palette-background-grey); height:46px;">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">Makine iş emri bekliyor</MudText>
                </div>
            }

            <MudDivider Class="my-2" />

            <MudGrid Spacing="0">
                <MudItem xs="4" Class="d-flex flex-column align-center border-r">
                    <MudIcon Icon="@Icons.Material.Filled.Thermostat" Color="MudBlazor.Color.Error" Size="MudBlazor.Size.Small" />
                    <MudText Typo="Typo.subtitle2" Color="MudBlazor.Color.Error"><b>@MachineStatus.AnlikSicaklik</b> <span style="font-size:0.7em">°C</span></MudText>
                </MudItem>

                <MudItem xs="4" Class="d-flex flex-column align-center border-r">
                    <MudIcon Icon="@Icons.Material.Filled.WaterDrop" Color="MudBlazor.Color.Info" Size="MudBlazor.Size.Small" />
                    <MudText Typo="Typo.subtitle2" Color="MudBlazor.Color.Info"><b>%@MachineStatus.AnlikSuSeviyesi</b></MudText>
                </MudItem>

                <MudItem xs="4" Class="d-flex flex-column align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Speed" Color="MudBlazor.Color.Success" Size="MudBlazor.Size.Small" />
                    <MudText Typo="Typo.subtitle2" Color="MudBlazor.Color.Success"><b>@MachineStatus.AnlikDevirRpm</b> <span style="font-size:0.7em">d/d</span></MudText>
                </MudItem>
            </MudGrid>

            @if (MachineStatus.IsInRecipeMode)
            {
                <div class="mt-3">
                    <div class="d-flex justify-space-between mb-1">
                        <MudText Typo="Typo.caption">İlerleme</MudText>
                        <MudText Typo="Typo.caption"><b>%@MachineStatus.ProsesYuzdesi</b></MudText>
                    </div>
                    <MudProgressLinear Color="MudBlazor.Color.Primary" Value="@MachineStatus.ProsesYuzdesi" Height="6px" Class="rounded-lg" Striped="true" />
                </div>
            }
        }
    </MudCardContent>
</MudCard>

<style>
    /* Kart Hover Efekti */
    .machine-card-hover {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        cursor: pointer;
        height: 100%; /* Grid içinde yükseklikleri eşitlemek için */
    }

        .machine-card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

    .border-r {
        border-right: 1px solid var(--mud-palette-divider);
    }
</style>

@code {
    [Parameter] public FullMachineStatus MachineStatus { get; set; }
    [Parameter] public EventCallback MouseClick { get; set; }

    private async Task OnClickCallback()
    {
       
    }

    private MudBlazor.Color GetStatusColor()
    {
        if (MachineStatus.ConnectionState != ConnectionStatus.Connected) return MudBlazor.Color.Dark;
        if (MachineStatus.HasActiveAlarm) return MudBlazor.Color.Error;
        if (MachineStatus.IsPaused) return MudBlazor.Color.Warning;
        if (MachineStatus.IsInRecipeMode) return MudBlazor.Color.Success;
        return MudBlazor.Color.Info; // Boşta (Mavi)
    }

    private string GetStatusText()
    {
        if (MachineStatus.ConnectionState != ConnectionStatus.Connected) return "KOPUK";
        if (MachineStatus.HasActiveAlarm) return "ALARM";
        if (MachineStatus.IsPaused) return "DURAKLADI";
        if (MachineStatus.IsInRecipeMode) return "ÇALIŞIYOR";
        return "BOŞTA";
    }

    private string GetCardStyle()
    {
        // Kartın üstüne durum renginde kalın bir çizgi çeker
        var colorHex = GetStatusColor() switch
        {
            MudBlazor.Color.Success => "#00c853", // Yeşil
            MudBlazor.Color.Error => "#f44336",   // Kırmızı
            MudBlazor.Color.Warning => "#ff9800", // Turuncu
            MudBlazor.Color.Info => "#29b6f6",    // Açık Mavi (Boşta)
            _ => "#78909c"                        // Gri (Kopuk)
        };
        return $"border-top: 4px solid {colorHex};";
    }
}