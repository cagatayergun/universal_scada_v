@* Dosya: TekstilScada.WebApp/Components/Shared/DashboardMachineCard.razor *@
@using TekstilScada.Models
@using Microsoft.AspNetCore.Components.Web
@using TekstilScada.WebApp.Components.Pages
@inject TekstilScada.WebApp.Services.ScadaDataService ScadaService
@using TekstilScada.WebApp.Services
@using TekstilScada.Repositories
@using TekstilScada.WebApp.Components.Shared
@inject ScadaDataService ScadaService
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime
<div class="card dashboard-machine-card @GetStatusCssClass()"
    

    <div class="card-header-dashboard">
        <span class="machine-id">@MachineStatus.MachineId.</span>
        <span class="machine-name">@MachineStatus.MachineName</span>
        <div class="status-indicator @GetStatusCssClass()"></div>
    </div>

    <div class="card-body-dashboard">

        <div class="status-line-dashboard">
            <span class="status-text @GetStatusCssClass()">@GetStatusText()</span>
            @if (MachineStatus.IsInRecipeMode)
            {
                <span class="step-info">Adım: @MachineStatus.AktifAdimNo</span>
            }
        </div>

        <div class="details-grid-dashboard">
            <span>REÇETE:</span> <span class="recipe-name">@MachineStatus.RecipeName </span>
            <span>PARTİ NO:</span> <span class="batch-id">@MachineStatus.BatchNumarasi </span>
        </div>

        <div class="data-row">
            <div class="data-kpi temp-kpi">
                <div class="label">SICAKLIK</div>
                <div class="value @GetStatusCssClass()">@GetFormattedTemperature()°C</div>
            </div>
            <div class="data-kpi rpm-kpi">
                <div class="label">DEVİR (RPM)</div>
                <div class="value">@MachineStatus.AnlikDevirRpm</div>
            </div>
        </div>

     <div class="sparkline-container-card">
            <div class="chart-title-sparkline">Sıcaklık Trendi (Son 15 dk)</div>
            @if (!_dataLoaded)
            {
                <div class="loading-sparkline">Yükleniyor...</div>
            }
            else if (!SparklineData.Any())
            {
                <div class="no-data-sparkline">Veri yok.</div>
            }
            else
            {
               
                <div id="@SparklineContainerId" class="sparkline-chart-area"></div>
            }
        </div>
        </div>
</div>

@code {
    [Parameter]
    public FullMachineStatus MachineStatus { get; set; } = new();

    [Parameter]
    public EventCallback<MouseEventArgs> OnClick { get; set; }
    private List<JsReadyTrendDataPoint> SparklineData { get; set; } = new();
    private bool _dataLoaded = false;
    private string SparklineContainerId => $"sparkline-chart-{MachineStatus.MachineId}";
    private bool _isDisposed = false;

 

 

   
    private string GetStatusText()
    {
        if (MachineStatus.ConnectionState != ConnectionStatus.Connected) return "BAĞLANTI YOK";
        if (MachineStatus.HasActiveAlarm) return $"ALARM: {MachineStatus.ActiveAlarmNumber}";
        if (MachineStatus.IsInRecipeMode) return "ÇALIŞIYOR";
        return "DURUYOR";
    }

    private string GetStatusCssClass()
    {
        if (MachineStatus.HasActiveAlarm) return "status-alarm";
        if (MachineStatus.IsInRecipeMode) return "status-running";
        return "status-stopped";
    }

    // WinForms'taki gibi AnlikSicaklik değerini 10'a bölerek gösterir
    private string GetFormattedTemperature()
    {
        return (MachineStatus.AnlikSicaklik / 10.0m).ToString("F1");
    }
   
}