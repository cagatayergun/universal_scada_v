@using TekstilScada.Models
@using TekstilScada.WebApp.Services
@using TekstilScada.Core.Localization
@using Microsoft.Extensions.Localization
@inject ScadaDataService ScadaService
@inject IStringLocalizer<SharedResource> Loc
@implements IDisposable


@if (Show)
{
    // Modal Arka Planı
    <div class="modal fade show d-block" tabindex="-1" role="dialog" @onclick="Close">

        <div class="modal-dialog modal-lg" role="document" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@MachineStatus?.MachineName @Loc["AnlikDetaylar"]</h5>
                    <button type="button" class="close btn-close" @onclick="Close" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    @if (MachineStatus == null)
                    {
                        <p>@Loc["MakineBilgileriYukleniyor"]</p>
                    }
                    else
                    {
                        <div class="row">
                            <div class="col-md-6">
                                <h6>@Loc["TemelBilgiler"]</h6>
                                <p><strong>ID:</strong> @MachineId</p>
                                <p><strong>@Loc["BaglantiDurumu"]:</strong> @MachineStatus.ConnectionState</p>
                                <p><strong>@Loc["MakineTipi"]:</strong> @MachineStatus.MakineTipi</p>
                                <p><strong>@Loc["OperatorLabel"]:</strong> @(MachineStatus.OperatorIsmi ?? "-")</p>
                            </div>
                            <div class="col-md-6">
                                <h6>@Loc["ProsesBilgileri"]</h6>
                                <p><strong>@Loc["ReceteLabel"]</strong> @(MachineStatus.RecipeName ?? "-")</p>
                                <p><strong>@Loc["PartiLabel"]</strong> @(MachineStatus.BatchNumarasi ?? "-")</p>
                                <p><strong>@Loc["AktifAdimLabel"]:</strong> @MachineStatus.AktifAdimNo - @MachineStatus.AktifAdimAdi</p>
                                <p><strong>@Loc["ProsesYuzdesi"]:</strong> @MachineStatus.ProsesYuzdesi%</p>
                            </div>
                        </div>

                        <hr />

                        <h6>@Loc["AnlikDegerler"]</h6>
                        <div class="details-grid-extended">
                            <div class="detail-item">
                                <strong>@Loc["Sicaklik"]:</strong>
                                <span class="@GetTempCssClass()">@GetFormattedTemperature()°C</span>
                            </div>
                            <div class="detail-item">
                                <strong>@Loc["Devir"]:</strong>
                                <span>@MachineStatus.AnlikDevirRpm RPM</span>
                            </div>
                            <div class="detail-item">
                                <strong>@Loc["SuSeviyesiLabel"]:</strong>
                                <span>@MachineStatus.AnlikSuSeviyesi</span>
                            </div>
                            <div class="detail-item">
                                <strong>@Loc["AlarmVar"]</strong>
                                <span class="@(MachineStatus.HasActiveAlarm ? "text-danger" : "text-success")">
                                    @(MachineStatus.HasActiveAlarm ? $"{Loc["Evet"]} ({MachineStatus.ActiveAlarmNumber})" : Loc["Hayir"])
                                </span>
                            </div>
                            <div class="detail-item">
                                <strong>@Loc["CalismaSuresi"]</strong>
                                <span>@MachineStatus.CalismaSuresiDakika @Loc["Dk"]</span>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="Close">@Loc["Kapat"]</button>
                    @if (MachineStatus != null)
                    {
                        @* Tam Detay Sayfasına Gitme butonu *@
                        <button type="button" class="btn btn-primary" @onclick="NavigateToFullDetail">@Loc["TamProsesKontrolu"]</button>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    [Parameter] public bool Show { get; set; }

    // KRİTİK EKLEME: @bind-Show için gerekli parametre
    [Parameter] public EventCallback<bool> ShowChanged { get; set; }

    [Parameter] public int MachineId { get; set; }

    // OnClose event'i (ek temizleme işlemleri için)
    [Parameter] public EventCallback OnClose { get; set; }

    [Inject] public NavigationManager NavManager { get; set; } = default!;

    private FullMachineStatus? MachineStatus => ScadaService.MachineData.ContainsKey(MachineId) ? ScadaService.MachineData[MachineId] : null;

    protected override void OnInitialized()
    {
        // Anlık veri güncellemelerini dinle
        ScadaService.OnDataUpdated += OnDataUpdatedHandler;
    }

    private void OnDataUpdatedHandler()
    {
        // KRİTİK DÜZELTME: Bu metodun unhandled exception fırlatmasını engeller.
        try
        {
            // YALNIZCA Modal açıksa ve ilgili makinenin verisi değişiyorsa UI'ı güncelle
            if (Show && MachineId != 0)
            {
                InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            // Bu, devrenin çökmesini engeller.
            //($"!!! KRİTİK MODAL VERİ GÜNCELLEME HATASI: {ex.Message}");
            // Hata Ayıklayıcıyı (Debugger) açıp buraya bir KESME NOKTASI (BREAKPOINT) koyun.
        }
    }

    public void Dispose()
    {
        ScadaService.OnDataUpdated -= OnDataUpdatedHandler;
    }

    private string GetFormattedTemperature() => (MachineStatus?.AnlikSicaklik / 10.0m)?.ToString("F1") ?? "-";

    private string GetTempCssClass() => MachineStatus?.AnlikSicaklik > 800 ? "text-danger" : "text-success"; // Örnek kural

    private async Task Close()
    {
        // 1. Ebeveyn bileşene Modal'ın kapandığını bildirir (showDetailModal = false yapar)
        await ShowChanged.InvokeAsync(false);

        // 2. Ebeveyn bileşendeki ek temizleme/sıfırlama işlemini tetikler (HandleModalClose).
        await OnClose.InvokeAsync();
    }

    private void NavigateToFullDetail()
    {
        // Modalı kapatıp ana detay sayfasına yönlendir
        Close();
        NavManager.NavigateTo($"/proseskontrol/{MachineId}");
    }
}