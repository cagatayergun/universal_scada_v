@using TekstilScada.Models
@using TekstilScada.WebApp.Services
@inject ScadaDataService DataService
@inject IJSRuntime JSRuntime

@if (showEditModal && operatorToEdit != null)
{
    <PlcOperatorEditModal Operator="operatorToEdit" OnClose="() => showEditModal = false" OnSave="HandleSave" />
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4>PLC Operatör Yönetimi</h4>
    <button class="btn btn-success" @onclick="AddDefaultOperator">
        <i class="bi bi-person-plus me-1"></i> Varsayılan Ekle
    </button>
</div>

@if (operators == null)
{
    <div class="text-center mt-4"><div class="spinner-border text-primary"></div><p>Yükleniyor...</p></div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Operatör Adı</th>
                    <th>Kullanıcı ID</th>
                    <th>Şifre</th>
                    <th class="text-end">İşlemler</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var op in operators)
                {
                    <tr>
                        <td class="fw-bold">@op.Name</td>
                        <td><span class="badge bg-info text-dark">@op.UserId</span></td>
                        <td>**** (@op.Password)</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-primary me-1" @onclick="() => EditOperator(op)">
                                <i class="bi bi-pencil me-1"></i> Düzenle
                            </button>
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteOperator(op)">
                                <i class="bi bi-trash me-1"></i> Sil
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<PlcOperator>? operators;
    private PlcOperator? operatorToEdit;
    private bool showEditModal = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try { operators = await DataService.GetPlcOperatorsAsync(); }
        catch (Exception ex) { Console.WriteLine($"Hata: {ex.Message}"); }
    }

    private async Task AddDefaultOperator()
    {
        await DataService.AddDefaultPlcOperatorAsync();
        await LoadData();
    }

    private void EditOperator(PlcOperator op)
    {
        // Kopyasını oluşturuyoruz
        operatorToEdit = new PlcOperator
        {
            SlotIndex = op.SlotIndex, // ID burada tutuluyor
            Name = op.Name,
            UserId = op.UserId,
            Password = op.Password
        };
        showEditModal = true;
    }

    private async Task HandleSave(PlcOperator op)
    {
        try
        {
            await DataService.SavePlcOperatorAsync(op);
            showEditModal = false;
            await LoadData();
        }
        catch (Exception ex) { await JSRuntime.InvokeVoidAsync("alert", $"Hata: {ex.Message}"); }
    }

    private async Task DeleteOperator(PlcOperator op)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"'{op.Name}' operatörü silinsin mi?"))
        {
            // Repository'de SlotIndex aslında veritabanı ID'si olarak kullanılıyor
            await DataService.DeletePlcOperatorAsync(op.SlotIndex);
            await LoadData();
        }
    }
}