@page "/reports/production-detail/{MachineId:int}/{BatchId}"
@using Universalscada.Repositories
@using Universalscada.core.Models
@using Universalscada.Models
@using Universalscada.WebApp.Services
@inject ScadaDataService ScadaDataService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
<PageTitle>Üretim Detayı - @BatchId</PageTitle>

@if (isLoading)
{
    <div class="alert alert-info text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        @statusMessage
    </div>
}
else if (detailData == null)
{
    <div class="alert alert-danger text-center">Üretim detayı bulunamadı.</div>
}
else
{
    <div class="production-detail-container">
        <h1 class="mb-4">Üretim Detay Raporu - @detailData.Header.BatchId</h1>

        <div class="card mb-4">
            <div class="card-header bg-light fw-bold">Genel Bilgiler</div>
            <div class="card-body">
                <div class="row">
                    <DetailItem Label="Makine Adı" Value="@detailData.Header.MachineName" />
                    <DetailItem Label="Reçete Adı" Value="@detailData.Header.RecipeName" />
                    <DetailItem Label="Operatör" Value="@detailData.Header.OperatorName" />
                    <DetailItem Label="Müşteri No" Value="@detailData.Header.MusteriNo" />
                    <DetailItem Label="Sipariş No" Value="@detailData.Header.SiparisNo" />
                </div>
                <div class="row mt-3">
                    <DetailItem Label="Başlangıç" Value="@detailData.Header.StartTime.ToString("dd.MM.yyyy HH:mm:ss")" />
                    <DetailItem Label="Bitiş" Value="@detailData.Header.EndTime.ToString("dd.MM.yyyy HH:mm:ss")" />
                    <DetailItem Label="Toplam Süre" Value="@detailData.Header.CycleTime" />
                </div>
                <button class="btn btn-primary mt-3" @onclick="ExportToExcel">
                    <i class="oi oi-data-transfer-download"></i> Excel'e Aktar
                </button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card h-100">
                    <div class="card-header fw-bold">Proses Zaman Çizgisi/Sıcaklık</div>
                    <div class="card-body">
                        <div id="trendChart" style="height: 400px;">
                            <p class="text-center text-muted">Zaman Çizgisi Grafiği burada gösterilecektir.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-header fw-bold">Süre Dağılımı (Pasta Grafik)</div>
                    <div class="card-body d-flex flex-column justify-content-center">
                        <div id="pie-chart" style="height: 250px;">
                            <p class="text-center text-muted">Pasta Grafik burada gösterilecektir.</p>
                        </div>
                        <div class="mt-3">
                            @foreach (var segment in pieChartSegments)
                            {
                                <div class="d-flex justify-content-between mb-1" style="border-left: 5px solid @segment.Color">
                                    <span class="fw-bold">@segment.Label</span>
                                    <span>@segment.Duration</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header fw-bold">Adım Detayları</div>
                    <div class="card-body table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Adım No</th>
                                    <th>Açıklama</th>
                                    <th>Teorik Süre</th>
                                    <th>Gerçekleşen Süre</th>
                                    <th>Sıcaklık</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var step in detailData.Steps)
                                {
                                    <tr style="@GetStepDurationStyle(step)">
                                        <td>@step.StepNumber</td>
                                        <td>@step.StepDescription</td>
                                        <td>@TimeSpan.FromSeconds(step.TheoreticalDurationSeconds).ToString(@"hh\:mm\:ss")</td>
                                        <td>@step.WorkingTime</td>
                                        <td>@step.Temperature.ToString("F1") °C</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header fw-bold">Alarm Geçmişi</div>
                    <div class="card-body table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Tip</th>
                                    <th>Açıklama</th>
                                    <th>Süre</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var alarm in detailData.Alarms)
                                {
                                    <tr>
                                        <td>@alarm.AlarmTime.ToString("HH:mm:ss")</td>
                                        <td>@alarm.AlarmType</td>
                                        <td>@alarm.AlarmDescription</td>
                                        <td>@alarm.Duration.ToString(@"hh\:mm\:ss")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int MachineId { get; set; }
    [Parameter] public string BatchId { get; set; } = string.Empty;

    // ScadaDataService'de tanımlanan DTO kullanılır
    private ProductionDetailDto? detailData;
    private bool isLoading = true;
    private string statusMessage = "Üretim detayları yükleniyor...";
    private List<PieChartSegment> pieChartSegments = new();
    private List<TrendDataPoint>? actualDataPoints;
    // API'dan gelen tüm veriyi tutacak DTO'lar (Tekrar tanımlanmıştır)
    private bool _chartsDrawn = false;
    private List<Trend
    taPoint>? trendDataPoints;
    private bool shouldRenderChart = false;
    private bool shouldRenderChart2 = false;
    private class PieChartSegment
    {
        public string Label { get; set; } = string.Empty;
        public string Color { get; set; } = string.Empty;
        public TimeSpan DurationTimeSpan { get; set; }
        public string Duration => DurationTimeSpan.ToString(@"hh\:mm\:ss");
        public double Value { get; set; } // Pasta grafiği için süre (saniye)
    }
    private class TrendProcessDataPoint
    {
        public int MachineId { get; set; }
        public DateTime Timestamp { get; set; }
        public decimal Temperature { get; set; }
        public decimal WaterLevel { get; set; }
        public int Rpm { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        if (MachineId == 0 || string.IsNullOrEmpty(BatchId))
        {
            statusMessage = "Hata: Makine veya Batch ID eksik.";
            isLoading = false;
            return;
        }

        try
        {
            // Tek bir API çağrısıyla tüm veriyi al (WinForms'taki birden çok Repository çağrısının karşılığı)
            // Bu metot ScadaDataService'e eklenmelidir.
            detailData = await ScadaDataService.GetProductionDetailAsync(MachineId, BatchId);
            await GenerateTrendReport();
            if (detailData != null)
            {
                CalculatePieChart(detailData.Header); // Pasta grafik verisini hesapla
                // Burada Chart.js veya Plotly gibi Blazor uyumlu bir kütüphane için JS interop çağrısı yapılmalıdır.
            }
            else
            {
                statusMessage = "Detaylar boş döndü.";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Veri yüklenirken hata oluştu: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Yalnızca ilk render işleminden sonra (ve veriler yüklendiğinde) JS interop'u çağır.
        if (shouldRenderChart2 && detailData != null && !_chartsDrawn)
        {
            await DrawPieChartAsync();

            _chartsDrawn = true;
            shouldRenderChart2 = false;
        }
        if (shouldRenderChart && trendDataPoints != null && trendDataPoints.Any())
        {
            shouldRenderChart = false; // Tekrar çizimi engelle

            // CallPlotlyJS, DOM'a erişimin garanti olduğu bu noktada çağrılır.
            await CallPlotlyJS();
        }
    }
    private async Task DrawPieChartAsync()
    {
        if (pieChartSegments.Any())
        {
            // JS tarafına gönderilecek basit veri formatı
            var chartData = pieChartSegments.Select(s => new
            {
                label = s.Label,
                value = s.DurationTimeSpan.TotalSeconds, // Pasta için saniye değerini gönder
                color = s.Color
            }).ToList();

            // JS interop çağrısı: 'window.drawPieChart' JS fonksiyonunu çağırır.
            await JSRuntime.InvokeVoidAsync("drawPieChart", "pie-chart", chartData);
        }
    }
    // Zaman Çizgisi / Sıcaklık Grafiği çizimini başlatan metot
  
    private async Task CallPlotlyJS()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("plotTrendChart",
                "trendChart",
                trendDataPoints,
                "Temperature");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Plotly JS çağrısı başarısız oldu:", ex.Message);
        }
    }
    private async Task GenerateTrendReport()
    {
        isLoading = true;
        actualDataPoints = null;
        // shouldRenderChart = false; // Temizle
        await InvokeAsync(StateHasChanged);

       

        try
        {
            var effectiveFilters = new ReportFilters
            {
                StartTime = detailData.Header.StartTime,
                EndTime = detailData.Header.EndTime,
                MachineId = MachineId,
            };

            await JSRuntime.InvokeVoidAsync("console.log", "API'ye gönderilen Trend filtreleri:", effectiveFilters);

            var rawData = await ScadaDataService.GetTrendDataAsync(effectiveFilters);

            if (rawData != null)
            {
                var jsonString = System.Text.Json.JsonSerializer.Serialize(rawData);
                var trendData = System.Text.Json.JsonSerializer.Deserialize<List<TrendProcessDataPoint>>(jsonString, new System.Text.Json.JsonSerializerOptions(System.Text.Json.JsonSerializerDefaults.Web));
                trendDataPoints = trendData;

                if (trendDataPoints.Any())
                {
                    shouldRenderChart = true; // DOM hazır olduğunda çizim yapsın diye flag'i true yaptık.
                }
                else
                {
                    shouldRenderChart = false;
                }
            }
        }
        catch (Exception ex)
        {
            shouldRenderChart = false;
            await JSRuntime.InvokeVoidAsync("console.error", "Trend Raporu oluşturulurken hata oluştu:", ex.ToString());
        }
        finally
        {
            isLoading = false;
            // Bu StateHasChanged, OnAfterRenderAsync'i tetikler.
            await InvokeAsync(StateHasChanged);
        }
    }
    // WinForms'taki LoadPieChart mantığının karşılığı
    private void CalculatePieChart(ProductionReportItem reportItem)
    {
        pieChartSegments.Clear();

        // 1. Saniye değerlerini al
        double totalMachineAlarmSeconds = reportItem.MachineAlarmDurationSeconds;
        double totalOperatorPauseSeconds = reportItem.OperatorPauseDurationSeconds;
        double totalBatchSeconds = (reportItem.EndTime - reportItem.StartTime).TotalSeconds;

        // 2. Aktif Süreyi Hesapla
        double activeWorkingSeconds = totalBatchSeconds - totalMachineAlarmSeconds - totalOperatorPauseSeconds;
        if (activeWorkingSeconds < 0) activeWorkingSeconds = 0;

        // 3. Segmentleri oluştur
        if (activeWorkingSeconds > 0)
        {
            pieChartSegments.Add(new PieChartSegment
            {
                Label = "Aktif Çalışma",
                Color = "DodgerBlue",
                DurationTimeSpan = TimeSpan.FromSeconds(activeWorkingSeconds),
                Value = activeWorkingSeconds // EKLENDİ
            });
        }
        if (totalMachineAlarmSeconds > 0)
        {
            pieChartSegments.Add(new PieChartSegment
            {
                Label = "Makine Alarm",
                Color = "Crimson",
                DurationTimeSpan = TimeSpan.FromSeconds(totalMachineAlarmSeconds),
                Value = totalMachineAlarmSeconds // EKLENDİ
            });
        }
        if (totalOperatorPauseSeconds > 0)
        {
            pieChartSegments.Add(new PieChartSegment
            {
                Label = "Operatör Duraklama",
                Color = "Orange",
                DurationTimeSpan = TimeSpan.FromSeconds(totalOperatorPauseSeconds),
                 Value = totalOperatorPauseSeconds // EKLENDİ
            });
        }

        if (!pieChartSegments.Any())
        {
            pieChartSegments.Add(new PieChartSegment { Label = "Veri Yok", Color = "Gray", DurationTimeSpan = TimeSpan.Zero });
        }
         if (pieChartSegments.Any())
                {
                    shouldRenderChart2 = true; // DOM hazır olduğunda çizim yapsın diye flag'i true yaptık.
                }
                else
                {
                    shouldRenderChart2 = false;
                }
    }

    // WinForms'taki dgvStepDetails_CellFormatting mantığının karşılığı (satır stili)
    private string GetStepDurationStyle(ProductionStepDetailDto step) // DTO kullanıldı
    {
        // Çalışma zamanı string'ini TimeSpan'a çevir
        if (TimeSpan.TryParse(step.WorkingTime, out TimeSpan workingTime) && step.TheoreticalDurationSeconds > 0)
        {
            // TheoreticalDurationSeconds property'si kullanıldı
            TimeSpan theoreticalTime = TimeSpan.FromSeconds(step.TheoreticalDurationSeconds);

            int theoreticalMinutes = (int)theoreticalTime.TotalMinutes;
            int workingMinutes = (int)workingTime.TotalMinutes;

            if (workingMinutes > theoreticalMinutes)
            {
                return "background-color: #f8d7da; color: #721c24; border-left: 5px solid red;";
            }
            else if (workingMinutes < theoreticalMinutes)
            {
                return "background-color: #d4edda; color: #155724; border-left: 5px solid green;";
            }
        }
        return string.Empty;
    }

    // WinForms'taki btnExportToExcel_Click mantığının karşılığı
    private async Task ExportToExcel()
    {
        if (detailData == null) return;

        statusMessage = "Excel dosyası hazırlanıyor...";
        isLoading = true;
        StateHasChanged();

        try
        {
            // KRİTİK GÜNCELLEME: Yeni byte[] döndüren metodu çağır
            var excelBytes = await ScadaDataService.ExportProductionDetailFileAsync(MachineId, BatchId);

            if (excelBytes.Any())
            {
                // JavaScript Interop ile dosyayı tarayıcıda indir.
                await JSRuntime.InvokeVoidAsync("saveAsFile",
                    $"Uretim_Detayi_{BatchId}_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx",
                    Convert.ToBase64String(excelBytes));

                await JSRuntime.InvokeVoidAsync("alert", "Rapor Excel olarak başarıyla dışa aktarıldı (İndirme başlatıldı).");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Excel dosyası boş döndü. (Sunucu hatası)");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Dışa aktarma hatası: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}