@using System.Text.Json
@using System.Text.Json.Serialization
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Universalscada.Models
@using Universalscada.Repositories
@inject IJSRuntime JSRuntime
@* --- DEĞİŞİKLİK 1: ESKİSİNİ SİLİN --- *@
@* @inject RecipeConfigurationRepository ConfigRepo *@

@* --- DEĞİŞİKLİK 2: API SERVİSİNİ EKLEYİN --- *@
@* (Servisinizin adı farklıysa burada düzeltin. Bu servis WebApp/Program.cs içinde kayıtlı olmalı) *@
@inject Universalscada.WebApp.Services.ScadaDataService ScadaService 

<div class="step-editor-container">

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Hata Oluştu:</strong>
            <pre style="white-space: pre-wrap; word-break: break-all;">@errorMessage</pre>
            <button type="button" class="btn-close" @onclick="() => errorMessage = null" aria-label="Close"></button>
        </div>
    }
    
    @* ... (HTML'in geri kalanı aynı kalır) ... *@
    @if (MachineSubType == "Kurutma Makinesi")
    {
        <div class="alert alert-info">
            Bu adım kurutma makinesine aittir. Editör yapısı statiktir.
        </div>
        <KurutmaStepEditor Step="Step" OnChanged="OnChanged" />
    }
    else
    {
        <div class="step-types">
            <h6>Adım Tipleri</h6>
            <div class="pnlStepTypes">
                @foreach (var stepType in StepTypes)
                {
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                               checked="@(IsStepTypeChecked(stepType.BitValue))"
                               @onchange="e => OnStepTypeChanged(stepType, (bool)e.Value)" />
                        <label>@stepType.Name</label>
                    </div>
                }
            </div>
        </div>
        <div class="step-params">
            <div class="flpParameters">
                @foreach (var stepInfo in ActiveStepInfos)
                {
                    <div class="card mb-3" style="border: 1px solid #ccc; background-color: @StepColorMap[stepInfo.Id];">
                        <div class="card-header" style="font-weight: bold;">@stepInfo.Name.ToUpper()</div>
                        <div class="card-body">
                            
                            @* Adıma ait dinamik kontrolleri filtrele ve render et *@
                            @foreach (var data in _activeControlsMetadata.Where(d => d.ParentStepId == stepInfo.Id))
                            {
                                <div class="mb-2">
                                    <label class="form-label me-2">@data.Text</label>
                                    @RenderControl(data, stepInfo.Id)
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public ScadaRecipeStep Step { get; set; }
    [Parameter] public string MachineSubType { get; set; } = "DEFAULT";
    [Parameter] public EventCallback OnChanged { get; set; }

    private bool _isUpdating = false;
    private List<StepControlMetadata> _activeControlsMetadata = new();
    private string? errorMessage; 

    // ... (Yardımcı sınıflar ve Veriler aynı kalır: StepControlMetadata, StepTypeInfo, StepTypes, StepColorMap) ...

    private class StepControlMetadata : ControlMetadata
    {
        public int ParentStepId { get; set; }
    }

    private class StepTypeInfo
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public short BitValue { get; set; }
        public int PLC_WordIndex { get; set; }
        public StepTypeInfo(int id, string name, short bitValue, int plcWordIndex) { Id = id; Name = name; BitValue = bitValue; PLC_WordIndex = plcWordIndex; }
    }

    private List<StepTypeInfo> StepTypes = new()
    {
        new StepTypeInfo(1, "Su Alma", 1, 0),    
        new StepTypeInfo(2, "Isıtma", 2, 2),     
        new StepTypeInfo(3, "Çalışma", 4, 14),   
        new StepTypeInfo(4, "Dozaj", 8, 5),      
        new StepTypeInfo(5, "Boşaltma", 16, 10), 
        new StepTypeInfo(6, "Sıkma", 32, 8)      
    };
    private List<StepTypeInfo> ActiveStepInfos => StepTypes.Where(s => IsStepTypeChecked(s.BitValue)).ToList();
    
    private readonly Dictionary<int, string> StepColorMap = new()
    {
        { 1, "rgba(204, 229, 255, 0.7)" }, { 2, "rgba(255, 204, 204, 0.7)" },
        { 3, "rgba(204, 255, 204, 0.7)" }, { 4, "rgba(255, 211, 106, 0.7)" },
        { 5, "rgba(173, 216, 230, 0.7)" }, { 6, "rgba(213, 213, 211, 0.7)" }
    };


    // --- LIFE CYCLE (GÜNCELLENDİ: HATA YAKALAMA EKLENDİ) ---
    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (ScadaService == null)
            {
                errorMessage = "Kritik Hata: ScadaDataService servisi 'Program.cs' içinde kayıtlı değil (Dependency Injection hatası).";
                return; 
            }

            if (Step == null)
            {
                Step = new ScadaRecipeStep();
            }
            
            if (Step.StepDataWords == null || Step.StepDataWords.Length < 25)
            {
                Step.StepDataWords = new short[25];
            }
            
            if (MachineSubType != "Kurutma Makinesi")
            {
                await LoadControlsData();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Bileşen yüklenirken kritik bir hata oluştu: {ex.Message}\n--- STACK TRACE ---\n{ex.StackTrace}";
        }
    }
    
    // ... (OnStepTypeChanged metodu aynı kalır, LoadControlsData'yı çağırdığı için o da hata yakalamış olur) ...
    private bool IsStepTypeChecked(short bit) => (Step != null && Step.StepDataWords.Length > 24 && (Step.StepDataWords[24] & bit) != 0);
    
    private async Task OnStepTypeChanged(StepTypeInfo changedStep, bool isChecked)
    {
        if (_isUpdating || Step == null) return;
        errorMessage = null; 

        try
        {
            short newControlWord = Step.StepDataWords[24];
            if (isChecked) newControlWord |= changedStep.BitValue;
            else newControlWord &= (short)~changedStep.BitValue;

            if (!IsSelectionValid(newControlWord))
            {
                errorMessage = "En fazla 2 farklı işlem türü seçilebilir veya Sıkma/Boşaltma adımları diğer standart adımlarla bir arada seçilemez.";
                return;
            }

            Step.StepDataWords[24] = newControlWord;
            
            await LoadControlsData();
            
            await OnChanged.InvokeAsync(null);
        }
        catch (Exception ex)
        {
             errorMessage = $"Adım tipi değiştirilirken hata oluştu: {ex.Message}\n--- STACK TRACE ---\n{ex.StackTrace}";
        }
    }

    // --- GÜNCELLENMİŞ METOT (API SERVİSİ KULLANIYOR) ---
    private async Task LoadControlsData()
    {
        try
        {
            _activeControlsMetadata.Clear();
            var activeStepIds = ActiveStepInfos.Select(s => s.Id).ToList();

            foreach(var stepId in activeStepIds)
            {
                // --- DEĞİŞİKLİK 3: ConfigRepo yerine API servisi çağrılır ---
                // (Metot adı ScadaDataService içinde farklı olabilir, varsayılan olarak GetLayoutJsonAsync kullanıldı)
                string layoutJson = await ScadaService.GetLayoutJsonAsync(MachineSubType, stepId);
                
                // API "DEFAULT" mantığını kendi içinde halletmiyorsa, onu burada tekrar deneyebiliriz.
                if (string.IsNullOrEmpty(layoutJson) && MachineSubType != "DEFAULT")
                {
                     layoutJson = await ScadaService.GetLayoutJsonAsync("DEFAULT", stepId);
                }
                                    
                if (!string.IsNullOrEmpty(layoutJson))
                {
                    try
                    {
                        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                        var controls = JsonSerializer.Deserialize<List<ControlMetadata>>(layoutJson, options);
                        
                        if (controls != null)
                        {
                            foreach(var control in controls)
                            {
                                _activeControlsMetadata.Add(new StepControlMetadata
                                {
                                    ParentStepId = stepId,
                                    ControlType = control.ControlType,
                                    Name = control.Name,
                                    Text = control.Text,
                                    PLC_WordIndex = control.PLC_WordIndex,
                                    PLC_BitIndex = control.PLC_BitIndex,
                                    DecimalPlaces = control.DecimalPlaces,
                                    Maximum = control.Maximum,
                                    StringWordLength = control.StringWordLength
                                });
                            }
                        }
                    }
                    catch (JsonException jsonEx)
                    {
                        errorMessage = $"API'den gelen JSON işlenemedi (Step ID {stepId}): {jsonEx.Message}. Gelen JSON: {layoutJson.Substring(0, Math.Min(layoutJson.Length, 100))}...";
                    }
                }
            }
        }
        catch (Exception ex)
        {
            // Bu, ScadaService.GetLayoutJsonAsync() API çağrısı sırasındaki hatayı yakalar
            errorMessage = $"Kontrol verisi API'den yüklenirken hata oluştu: {ex.Message}\n--- STACK TRACE ---\n{ex.StackTrace}";
        }
        
        await InvokeAsync(StateHasChanged);
    }
    
    // ... (Kural Kontrolü, PLC Veri Yönetimi ve RenderControl metotları aynı kalır) ...
    
    private bool IsSelectionValid(short controlWord)
    {
        var checkedSteps = StepTypes.Where(s => (controlWord & s.BitValue) != 0).ToList();
        int checkedCount = checkedSteps.Count;

        if (checkedCount > 2) return false;

        var specialStepIds = new List<int> { 5, 6 };
        var standardStepIds = new List<int> { 1, 2, 3, 4 };

        bool isAnySpecialChecked = checkedSteps.Any(c => specialStepIds.Contains(c.Id));
        bool isAnyStandardChecked = checkedSteps.Any(c => standardStepIds.Contains(c.Id));

        if (isAnySpecialChecked && isAnyStandardChecked) return false;
        
        return true;
    }

    private string GetStringValue(int wordIndex, int length)
    {
        if (Step == null || wordIndex + length > Step.StepDataWords.Length) return string.Empty;
        char[] chars = new char[length * 2];
        for (int i = 0; i < length; i++)
        {
            short word = Step.StepDataWords[wordIndex + i];
            chars[i * 2] = (char)(word & 0xFF);
            chars[i * 2 + 1] = (char)((word >> 8) & 0xFF);
        }
        return new string(chars).TrimEnd('\0');
    }

    private void SetStringValue(int wordIndex, int length, string value)
    {
        if (Step == null || wordIndex + length > Step.StepDataWords.Length) return;
        string paddedValue = value.PadRight(length * 2, '\0');
        for (int i = 0; i < length; i++)
        {
            int charIndex = i * 2;
            short word = 0;
            if (charIndex < paddedValue.Length)
                word |= (short)paddedValue[charIndex];
            if (charIndex + 1 < paddedValue.Length)
                word |= (short)(paddedValue[charIndex + 1] << 8);
            Step.StepDataWords[wordIndex + i] = word;
        }
    }

    private decimal GetNumericValue(int wordIndex, int decimalPlaces)
    {
        if (Step == null || wordIndex >= Step.StepDataWords.Length) return 0;
        decimal value = Step.StepDataWords[wordIndex];
        if (decimalPlaces > 0) value /= (decimal)Math.Pow(10, decimalPlaces);
        return value;
    }

    private bool GetBitValue(int wordIndex, int bitIndex)
    {
        if (Step == null || wordIndex >= Step.StepDataWords.Length) return false;
        short word = Step.StepDataWords[wordIndex];
        int bitMask = 1 << bitIndex;
        return (word & bitMask) != 0;
    }

    private async Task OnDynamicControlValueChanged(ChangeEventArgs e, ControlMetadata data)
    {
        if (_isUpdating || Step == null || data.PLC_WordIndex >= Step.StepDataWords.Length) return;
        
        try
        {
            if (data.ControlType.Contains("NumericUpDown") || data.ControlType == "InputNumber")
            {
                if (decimal.TryParse(e.Value?.ToString(), out decimal newValue))
                {
                    if (data.DecimalPlaces > 0)
                        Step.StepDataWords[data.PLC_WordIndex] = (short)(newValue * (decimal)Math.Pow(10, data.DecimalPlaces));
                    else
                        Step.StepDataWords[data.PLC_WordIndex] = (short)Math.Round(newValue);
                }
            }
            else if (data.ControlType.Contains("CheckBox") || data.ControlType == "InputCheckbox")
            {
                if (bool.TryParse(e.Value?.ToString(), out bool isChecked))
                {
                    SetBit(Step.StepDataWords, data.PLC_WordIndex, data.PLC_BitIndex, isChecked);
                }
            }
            else if (data.ControlType.Contains("TextBox") || data.ControlType == "InputText")
            {
                string newValue = e.Value?.ToString() ?? string.Empty;
                if (data.StringWordLength > 0)
                {
                    SetStringValue(data.PLC_WordIndex, data.StringWordLength, newValue);
                }
            }

            await OnChanged.InvokeAsync(null);
        }
        catch (Exception ex)
        {
            errorMessage = $"Değer değiştirilirken hata oluştu: {ex.Message}";
        }
    }

    private void SetBit(short[] data, int wordIndex, int bitIndex, bool value)
    {
        if (value) data[wordIndex] = (short)(data[wordIndex] | (1 << bitIndex));
        else data[wordIndex] = (short)(data[wordIndex] & ~(1 << bitIndex));
    }

    private RenderFragment RenderControl(ControlMetadata data, int stepId)
    {
        return builder =>
        {
            try
            {
                if (data.ControlType.Contains("NumericUpDown") || data.ControlType == "InputNumber")
                {
                    decimal currentValue = GetNumericValue(data.PLC_WordIndex, data.DecimalPlaces);

                    builder.OpenElement(0, "input");
                    builder.AddAttribute(1, "type", "number");
                    builder.AddAttribute(2, "class", "form-control");
                    builder.AddAttribute(3, "max", data.Maximum);
                    builder.AddAttribute(4, "step", data.DecimalPlaces > 0 ? (1m / (decimal)Math.Pow(10, data.DecimalPlaces)).ToString() : "1");
                    builder.AddAttribute(5, "value", currentValue);
                    builder.AddAttribute(6, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(this, e => OnDynamicControlValueChanged(e, data)));
                    builder.CloseElement();
                }
                else if (data.ControlType.Contains("CheckBox") || data.ControlType == "InputCheckbox")
                {
                    bool isChecked = GetBitValue(data.PLC_WordIndex, data.PLC_BitIndex);
                    
                    builder.OpenElement(0, "input");
                    builder.AddAttribute(1, "type", "checkbox");
                    builder.AddAttribute(2, "class", "form-check-input");
                    builder.AddAttribute(3, "checked", isChecked);
                    builder.AddAttribute(4, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(this, e => OnDynamicControlValueChanged(e, data)));
                    builder.CloseElement();
                }
                else if (data.ControlType.Contains("TextBox") || data.ControlType == "InputText")
                {
                    string currentValue = GetStringValue(data.PLC_WordIndex, data.StringWordLength);
                    
                    builder.OpenElement(0, "input");
                    builder.AddAttribute(1, "type", "text");
                    builder.AddAttribute(2, "class", "form-control");
                    builder.AddAttribute(3, "maxlength", data.StringWordLength * 2); 
                    builder.AddAttribute(4, "value", currentValue);
                    builder.AddAttribute(5, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(this, e => OnDynamicControlValueChanged(e, data)));
                    builder.CloseElement();
                }
            }
            catch (Exception ex)
            {
                errorMessage = $"Kontrol '{data.Text}' render edilirken hata oluştu: {ex.Message}";
                builder.OpenElement(0, "div");
                builder.AddAttribute(1, "class", "text-danger");
                builder.AddContent(2, $"Kontrol yüklenemedi: {ex.Message}");
                builder.CloseElement();
            }
        };
    }
}